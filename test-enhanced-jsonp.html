<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced JSONP Test - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏≠‡∏∏‡∏î‡∏£</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 2rem; }
        .test-card { margin-bottom: 1rem; }
        .test-result { font-family: monospace; background: #f8f9fa; padding: 1rem; border-radius: 5px; }
        .test-pass { color: #28a745; }
        .test-fail { color: #dc3545; }
        .test-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <h1 class="text-center mb-4">üß™ Enhanced JSONP System Test</h1>
                
                <!-- Test Configuration -->
                <div class="card test-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üîß Test Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Test QR Code</label>
                                <input type="text" id="testQRCode" class="form-control" value="02-25681225001234567" placeholder="XX-XXXXXXXXXXXXXXXXX">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Test Mode</label>
                                <select id="testMode" class="form-control">
                                    <option value="validation">QR Validation Only</option>
                                    <option value="jsonp">JSONP API Call</option>
                                    <option value="both">Complete Flow Test</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="runTests()">üöÄ Run Tests</button>
                            <button class="btn btn-warning" onclick="clearResults()">üßπ Clear Results</button>
                        </div>
                    </div>
                </div>

                <!-- Test Results -->
                <div class="card test-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìä Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" class="test-result">
                            <p class="text-muted">Click "Run Tests" to start testing...</p>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="card test-card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">‚ÑπÔ∏è System Information</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemInfo" class="test-result">
                            <p>Loading system information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    
    <script>
        // Mock the Enhanced JSONP components from search.html for testing
        const ENHANCED_JSONP_CONFIG = {
            enabled: true,
            debug: true,
            maxRetries: 2,
            fallbackToLegacy: true,
            enableForRoles: ['admin', 'group', 'farmer', 'public'],
            emergencyDisable: false
        };

        // Enhanced QR Code validation (copied from search.html)
        function validateEnhancedQRCode(qrCode) {
            const qrPattern = /^(\d{2})-(\d{17})$/;
            const match = qrCode.match(qrPattern);
            
            if (!match) {
                throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô XX-XXXXXXXXXXXXXXXXX');
            }
            
            const groupCode = match[1];
            const plotNumber = match[2];
            
            // Validate Group Code (01-99)
            const groupNum = parseInt(groupCode);
            if (groupNum < 1 || groupNum > 99) {
                throw new Error('‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 01-99');
            }
            
            // Validate Plot Number (not all zeros)
            if (plotNumber === '00000000000000000') {
                throw new Error('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
            
            // Check if starts with valid year (25xx for Buddhist year)
            const yearPrefix = plotNumber.substring(0, 4);
            const currentYear = new Date().getFullYear() + 543;
            const plotYear = parseInt(yearPrefix);
            
            if (plotYear < 2560 || plotYear > currentYear + 2) {
                throw new Error(`‡∏õ‡∏µ‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${plotYear}) ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 2560-${currentYear + 2}`);
            }
            
            // Additional validation
            const monthDay = plotNumber.substring(4, 8);
            const month = parseInt(monthDay.substring(0, 2));
            const day = parseInt(monthDay.substring(2, 4));
            
            if (month < 1 || month > 12) {
                throw new Error('‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 01-12)');
            }
            
            if (day < 1 || day > 31) {
                throw new Error('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 01-31)');
            }
            
            return { 
                groupCode, 
                plotNumber, 
                isValid: true,
                groupNumber: groupNum,
                plotYear: plotYear,
                plotMonth: month,
                plotDay: day
            };
        }

        // Test Functions
        async function runTests() {
            const results = document.getElementById('testResults');
            const qrCode = document.getElementById('testQRCode').value;
            const testMode = document.getElementById('testMode').value;
            
            results.innerHTML = '<p class="text-info">üîÑ Running tests...</p>';
            
            let testOutput = [];
            testOutput.push(`<h6>üß™ Test Started: ${new Date().toLocaleString('th-TH')}</h6>`);
            testOutput.push(`<p><strong>QR Code:</strong> ${qrCode}</p>`);
            testOutput.push(`<p><strong>Test Mode:</strong> ${testMode}</p>`);
            testOutput.push('<hr>');

            // Test 1: QR Code Validation
            if (testMode === 'validation' || testMode === 'both') {
                testOutput.push('<h6>üìù Test 1: QR Code Validation</h6>');
                try {
                    const validation = validateEnhancedQRCode(qrCode);
                    testOutput.push(`<p class="test-pass">‚úÖ Validation PASSED</p>`);
                    testOutput.push(`<pre>${JSON.stringify(validation, null, 2)}</pre>`);
                } catch (error) {
                    testOutput.push(`<p class="test-fail">‚ùå Validation FAILED: ${error.message}</p>`);
                }
                testOutput.push('<hr>');
            }

            // Test 2: JSONP Configuration
            testOutput.push('<h6>‚öôÔ∏è Test 2: Configuration Check</h6>');
            testOutput.push(`<p>Enhanced JSONP Enabled: <span class="${ENHANCED_JSONP_CONFIG.enabled ? 'test-pass' : 'test-fail'}">${ENHANCED_JSONP_CONFIG.enabled ? '‚úÖ YES' : '‚ùå NO'}</span></p>`);
            testOutput.push(`<p>Debug Mode: <span class="${ENHANCED_JSONP_CONFIG.debug ? 'test-pass' : 'test-warning'}">${ENHANCED_JSONP_CONFIG.debug ? '‚úÖ ON' : '‚ö†Ô∏è OFF'}</span></p>`);
            testOutput.push(`<p>Fallback Enabled: <span class="${ENHANCED_JSONP_CONFIG.fallbackToLegacy ? 'test-pass' : 'test-warning'}">${ENHANCED_JSONP_CONFIG.fallbackToLegacy ? '‚úÖ YES' : '‚ö†Ô∏è NO'}</span></p>`);
            testOutput.push('<hr>');

            // Test 3: API Configuration
            testOutput.push('<h6>üåê Test 3: API Configuration</h6>');
            if (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) {
                testOutput.push(`<p class="test-pass">‚úÖ API URL Configured: ${CONFIG.API_BASE_URL}</p>`);
                
                try {
                    const url = new URL(CONFIG.API_BASE_URL);
                    testOutput.push(`<p class="test-pass">‚úÖ URL Format Valid</p>`);
                    testOutput.push(`<p>Protocol: ${url.protocol === 'https:' ? '<span class="test-pass">‚úÖ HTTPS</span>' : '<span class="test-warning">‚ö†Ô∏è ' + url.protocol + '</span>'}</p>`);
                    testOutput.push(`<p>Host: ${url.host}</p>`);
                } catch (error) {
                    testOutput.push(`<p class="test-fail">‚ùå URL Format Invalid: ${error.message}</p>`);
                }
            } else {
                testOutput.push(`<p class="test-fail">‚ùå API URL Not Configured</p>`);
            }
            testOutput.push('<hr>');

            // Test 4: Browser Compatibility
            testOutput.push('<h6>üåê Test 4: Browser Compatibility</h6>');
            testOutput.push(`<p>Crypto API: <span class="${window.crypto && window.crypto.getRandomValues ? 'test-pass' : 'test-warning'}">${window.crypto && window.crypto.getRandomValues ? '‚úÖ Available' : '‚ö†Ô∏è Fallback'}</span></p>`);
            testOutput.push(`<p>URL Constructor: <span class="${typeof URL !== 'undefined' ? 'test-pass' : 'test-fail'}">${typeof URL !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}</span></p>`);
            testOutput.push(`<p>URLSearchParams: <span class="${typeof URLSearchParams !== 'undefined' ? 'test-pass' : 'test-fail'}">${typeof URLSearchParams !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}</span></p>`);

            testOutput.push('<hr>');
            testOutput.push(`<p class="test-pass"><strong>üéâ Test Complete: ${new Date().toLocaleString('th-TH')}</strong></p>`);

            results.innerHTML = testOutput.join('');
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '<p class="text-muted">Results cleared. Click "Run Tests" to start testing...</p>';
        }

        // Load system information on page load
        document.addEventListener('DOMContentLoaded', function() {
            const systemInfo = document.getElementById('systemInfo');
            const info = [];
            
            info.push(`<p><strong>Browser:</strong> ${navigator.userAgent}</p>`);
            info.push(`<p><strong>Screen Resolution:</strong> ${screen.width}x${screen.height}</p>`);
            info.push(`<p><strong>Language:</strong> ${navigator.language}</p>`);
            info.push(`<p><strong>Online:</strong> ${navigator.onLine ? '‚úÖ Yes' : '‚ùå No'}</p>`);
            info.push(`<p><strong>Local Time:</strong> ${new Date().toLocaleString('th-TH')}</p>`);
            
            systemInfo.innerHTML = info.join('');
        });

        // Test different QR codes
        function loadTestQRCode(qrCode) {
            document.getElementById('testQRCode').value = qrCode;
        }
    </script>

    <div class="text-center mt-4">
        <h6>üéØ Quick Test QR Codes:</h6>
        <div class="btn-group-vertical" role="group">
            <button class="btn btn-outline-success btn-sm" onclick="loadTestQRCode('02-25681225001234567')">‚úÖ Valid QR Code</button>
            <button class="btn btn-outline-warning btn-sm" onclick="loadTestQRCode('99-25681225001234567')">‚ö†Ô∏è High Group Code</button>
            <button class="btn btn-outline-danger btn-sm" onclick="loadTestQRCode('00-25681225001234567')">‚ùå Invalid Group Code</button>
            <button class="btn btn-outline-danger btn-sm" onclick="loadTestQRCode('02-20001225001234567')">‚ùå Invalid Year</button>
            <button class="btn btn-outline-danger btn-sm" onclick="loadTestQRCode('02-25681500001234567')">‚ùå Invalid Month</button>
        </div>
    </div>
</body>
</html>