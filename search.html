<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏≠‡∏∏‡∏î‡∏£</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            /* Modern Green Theme */
            --bg: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
            --card: #ffffff;
            --muted: #6b7280;
            --text: #111827;
            --brand: #10b981;
            --brand-2: #059669;
            --accent: #f59e0b;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --ring: rgba(16,185,129,.2);
            --shadow: 0 25px 50px -12px rgba(0,0,0,.25);
            --shadow-lg: 0 35px 60px -12px rgba(0,0,0,.3);
            --radius: 16px;
            --radius-lg: 24px;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        html{scroll-behavior:smooth}
        body{
            margin:0;
            font-family:"Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: var(--bg);
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }
        a{color:inherit;text-decoration:none}
        .container{width:min(1120px, 92vw); margin-inline:auto}

        /* NAVBAR */
        .nav{
            position:sticky; top:0; z-index:50;
            backdrop-filter:saturate(160%) blur(8px);
            background:rgba(255,255,255,.85);
            border-bottom:1px solid rgba(14,43,31,.08);
        }
        .nav-inner{display:flex;align-items:center;gap:16px; padding:14px 0}
        .brand{display:flex;align-items:center;gap:12px; font-weight:800; letter-spacing:.2px; color:#0a3c2a}
        .brand .logo{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;
            background:conic-gradient(from 210deg at 50% 50%, #28a745 0 40%, #198754 40% 70%, #ffd166 70% 100%);
            box-shadow:inset 0 0 0 4px rgba(0,0,0,.03), 0 6px 18px rgba(25,135,84,.25);
        }
        .spacer{flex:1}
        .nav a.link{opacity:.85; transition:.2s; padding:.5rem .75rem; border-radius:10px}
        .nav a.link:hover{opacity:1; background:rgba(25,135,84,.08)}

        /* BUTTONS */
        .btn{display:inline-flex; align-items:center; gap:8px; padding:.65rem 1rem; border-radius:12px;
            background:linear-gradient(180deg, var(--brand), var(--brand-2)); box-shadow:0 10px 18px rgba(25,135,84,.25);
            color:#fff; font-weight:800}
        .btn:hover{filter:brightness(1.03)}
        .btn-outline{display:inline-flex; align-items:center; gap:8px; padding:.55rem .95rem; border-radius:12px;
            border:2px solid var(--brand); color:var(--brand); font-weight:800; background:transparent}
        .btn-outline:hover{background:rgba(25,135,84,.08)}

        /* Search specific styles */
        .main-content{padding-top:88px}
        .info-card {
            background: var(--card);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 1px solid rgba(14,43,31,.12);
            box-shadow: var(--shadow);
        }
        .info-card h6 {
            border-bottom: 1px solid rgba(14,43,31,.12);
            padding-bottom: 0.5rem;
            color: var(--brand);
        }
        .card {
            background: var(--card);
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        .card-header {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            border-radius: 0;
            padding: 2rem;
            font-weight: 700;
            border: none;
            position: relative;
        }
        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 2s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .card-body {
            padding: 2.5rem;
        }
        .form-control {
            border: 2px solid #e5e7eb;
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }
        .form-control:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px var(--ring);
            outline: none;
        }
        .form-control.form-control-lg {
            padding: 1.25rem 1.5rem;
            font-size: 1.2rem;
        }
        .btn {
            padding: 1rem 2rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-success {
            background: linear-gradient(135deg, var(--brand), var(--brand-2));
            color: white;
            box-shadow: 0 10px 25px -5px rgba(16,185,129,0.4);
        }
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 30px -5px rgba(16,185,129,0.4);
            color: white;
            filter: brightness(1.05);
        }
        .btn-success:active {
            transform: translateY(0px);
            box-shadow: 0 5px 15px -5px rgba(16,185,129,0.3);
            transition: all 0.1s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--info), #2563eb);
            color: white;
            box-shadow: 0 10px 25px -5px rgba(59,130,246,0.4);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 30px -5px rgba(59,130,246,0.4);
            color: white;
            filter: brightness(1.05);
        }
        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 5px 15px -5px rgba(59,130,246,0.3);
            transition: all 0.1s ease;
        }
        .btn-outline-secondary {
            border: 2px solid var(--muted);
            color: var(--muted);
            background: transparent;
            border-radius: 12px;
            font-weight: 700;
        }
        .btn-outline-success {
            border: 2px solid var(--brand);
            color: var(--brand);
            background: transparent;
            border-radius: 12px;
            font-weight: 700;
        }
        .text-success { color: var(--brand) !important; }
        .text-primary { color: #0d6efd !important; }
        .text-muted { color: var(--muted) !important; }
        .bg-success { background: linear-gradient(135deg, var(--brand), var(--brand-2)) !important; }
        .bg-primary { background: linear-gradient(135deg, #0d6efd, #0b5ed7) !important; }
        .bg-light { background: rgba(245,255,247,.6) !important; }
        .alert {
            border-radius: 12px;
            border: 1px solid rgba(14,43,31,.15);
        }
        .alert-info {
            background: rgba(13,202,240,.1);
            border-color: rgba(13,202,240,.2);
            color: #055160;
        }
        .alert-warning {
            background: rgba(255,193,7,.1);
            border-color: rgba(255,193,7,.2);
            color: #664d03;
        }
        .alert-danger {
            background: rgba(220,53,69,.1);
            border-color: rgba(220,53,69,.2);
            color: #842029;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
        }
        .display-4 {
            font-size: 2.5rem;
            font-weight: 900;
        }
        .lead {
            font-size: 1.1rem;
            color: var(--muted);
        }
        \n        /* Bootstrap compatibility */\n        .row { display: flex; flex-wrap: wrap; margin: 0 -12px; }\n        .col-12 { flex: 0 0 100%; padding: 0 12px; }\n        .col-md-6 { flex: 0 0 50%; padding: 0 12px; }\n        .col-md-8 { flex: 0 0 66.666667%; padding: 0 12px; }\n        .col-md-4 { flex: 0 0 33.333333%; padding: 0 12px; }\n        .col-lg-8 { flex: 0 0 66.666667%; padding: 0 12px; }\n        @media (max-width: 768px) {\n            .col-md-6, .col-md-8, .col-md-4, .col-lg-8 { flex: 0 0 100%; }\n        }\n        .mb-3 { margin-bottom: 1rem; }\n        .mb-4 { margin-bottom: 1.5rem; }\n        .mb-5 { margin-bottom: 3rem; }\n        .mt-2 { margin-top: 0.5rem; }\n        .mt-3 { margin-top: 1rem; }\n        .mt-4 { margin-top: 1.5rem; }\n        .me-1 { margin-right: 0.25rem; }\n        .me-2 { margin-right: 0.5rem; }\n        .me-3 { margin-right: 1rem; }\n        .w-100 { width: 100%; }\n        .text-center { text-align: center; }\n        .pt-5 { padding-top: 3rem; }\n        .py-5 { padding: 3rem 0; }\n        .fw-bold { font-weight: 700; }\n        .d-flex { display: flex; }\n        .align-items-center { align-items: center; }\n        .align-items-end { align-items: flex-end; }\n        .justify-content-center { justify-content: center; }\n        .gap-2 { gap: 0.5rem; }\n        .gap-3 { gap: 1rem; }\n        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }\n        .form-label { margin-bottom: 0.5rem; font-weight: 600; display: block; }\n        .form-text { margin-top: 0.25rem; font-size: 0.875rem; color: var(--muted); }\n        .spinner-border { width: 2rem; height: 2rem; border: 0.25em solid; border-right-color: transparent; border-radius: 50%; animation: spinner-border 0.75s linear infinite; }\n        @keyframes spinner-border { to { transform: rotate(360deg); } }\n        .fade { transition: opacity 0.15s linear; }\n        .show { opacity: 1; }\n        .btn-close { background: transparent; border: 0; font-size: 1rem; opacity: 0.5; }\n        .btn-close:hover { opacity: 0.75; }\n        .modal { position: fixed; top: 0; left: 0; z-index: 1055; width: 100%; height: 100%; overflow-x: hidden; overflow-y: auto; outline: 0; }\n        .modal-dialog { position: relative; width: auto; margin: 0.5rem; pointer-events: none; }\n        .modal-content { position: relative; display: flex; flex-direction: column; width: 100%; pointer-events: auto; background: white; border: 1px solid rgba(0,0,0,.2); border-radius: var(--radius); outline: 0; }\n        .modal-body { position: relative; flex: 1 1 auto; padding: 1rem; }\n        .modal-sm { max-width: 300px; }\n        
        /* Enhanced Mobile Responsive */
        @media (max-width: 768px) {
            .card-header { padding: 1.5rem 1rem; }
            .card-body { padding: 1.5rem 1rem; }
            .btn { 
                padding: 1rem 1.5rem; 
                font-size: 1rem; 
                min-height: 48px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            .display-4 { font-size: 2rem; }
            .card:hover { transform: translateY(-2px); }
            .container { width: 95vw; }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .btn-success:hover, .btn-primary:hover {
                transform: none;
                filter: brightness(1.1);
                box-shadow: 0 8px 20px -5px rgba(16,185,129,0.3);
            }
            .btn-success:active, .btn-primary:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
                box-shadow: 0 3px 10px -3px rgba(16,185,129,0.4);
            }
            
            /* Navigation responsive */
            .nav-inner { 
                flex-wrap: wrap;
                gap: 8px; 
                padding: 12px 0; 
            }
            .brand { 
                font-size: 0.9rem;
            }
            .nav .link {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            .nav .btn, .nav .btn-outline { 
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                min-height: 36px;
            }
            
            /* Form controls responsive */
            .form-control {
                font-size: 16px; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ zoom ‡πÉ‡∏ô iOS */
                padding: 1rem;
                border-radius: 12px;
            }
            .form-control.form-control-lg {
                padding: 1.125rem;
                font-size: 16px;
            }
            
            /* Info cards responsive */
            .info-card {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            /* Main content spacing */
            .main-content {
                padding-top: 100px;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .card-header { padding: 1rem 0.75rem; }
            .card-body { padding: 1rem 0.75rem; }
            .btn { 
                padding: 1rem 1.25rem; 
                font-size: 0.95rem; 
                width: 100%;
                margin-bottom: 0.5rem;
                min-height: 44px;
            }
            .display-4 { font-size: 1.75rem; }
            .container { width: 98vw; }
            
            /* Navigation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
            .nav-inner {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            .brand {
                font-size: 0.85rem;
                flex-direction: column;
                gap: 4px;
            }
            .brand .logo {
                width: 28px;
                height: 28px;
            }
            
            /* Form adjustments for very small screens */
            .form-control {
                padding: 0.875rem;
                font-size: 16px;
            }
            .form-control.form-control-lg {
                padding: 1rem;
                font-size: 16px;
            }
            
            .info-card {
                padding: 0.75rem;
            }
            
            /* Typography adjustments */
            h1 { font-size: 1.5rem; }
            h6 { font-size: 1rem; }
            p { font-size: 0.9rem; }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
            .btn:active {
                transform: scale(0.96);
                transition: transform 0.1s ease;
            }
        }
        
        /* Touch-Friendly Interactions */
        .btn, .form-control, .nav .link, .nav .btn-outline {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ */
        .btn:focus-visible {
            outline: 2px solid var(--brand);
            outline-offset: 2px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px var(--ring);
        }
        
        /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 44px ‡∏ï‡∏≤‡∏° Apple HIG */
        .btn, .nav .link, .nav .btn-outline {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="container nav-inner">
            <a href="index.html" class="brand" aria-label="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å">
                <img src="assets/images/logo.png" width="32" height="32" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ" style="display:block;" />
                <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏≠‡∏∏‡∏î‡∏£</span>
            </a>
            <a class="link" href="index.html#gallery">‡πÅ‡∏Å‡∏•‡∏≠‡∏£‡∏µ‡πà</a>
            <div class="spacer"></div>
            <a class="btn-outline" href="search.html" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
            <a class="btn" href="login.html" aria-label="‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content pt-5">
        <div class="container">
            <!-- Hero Section -->
            <div class="row mb-5">
                <div class="col-12 text-center">
                    <h1 class="display-4 fw-bold text-success mb-4">
                        <i class="fas fa-search-plus me-3"></i>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å
                    </h1>
                    <p class="lead text-muted mb-5">
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß ‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û
                    </p>
                </div>
            </div>

            <!-- QR Code Search -->
            <div id="qrSearchSection" class="row mb-5">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-qrcode me-2"></i>
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="qrCodeSearchForm">
                                <div class="mb-3">
                                    <label for="qrCodeInput" class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ </label>
                                    <input type="text" class="form-control form-control-lg" id="qrCodeInput" 
                                           placeholder="‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™: 02-12345678901234567" required>
                                    <div class="form-text">
                                        <i class="fas fa-qrcode text-success me-1"></i>
                                        ‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: XX-XXXXXXXXXXXXXXXXX
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success w-100" style="background: linear-gradient(180deg, var(--brand), var(--brand-2)); border: none; border-radius: 12px; padding: .75rem 1.5rem; font-weight: 700; box-shadow: 0 8px 20px rgba(25,135,84,.25);">
                                    <i class="fas fa-search me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QR Code Results (Farmer Info) -->
            <div id="qrResults" class="row" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Farmer Basic Info -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <h6 class="text-success mb-3"><i class="fas fa-user me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h6>
                                        <p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏õ‡∏•‡∏á GAP:</strong> <span id="qrPlotNumber" class="text-primary"></span></p>
                                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="qrFarmerName"></span></p>
                                        <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="qrFarmerPhone"></span></p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-card">
                                        <h6 class="text-success mb-3"><i class="fas fa-map-marker-alt me-2"></i>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h6>
                                        <p><strong>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å:</strong> <span id="qrFarmerAddress"></span></p>
                                        <p><strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="qrFarmerArea"></span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Crop Verification Section -->
                            <div class="card border-warning mt-3">
                                <div class="card-body">
                                    <h6 class="text-warning mb-3">
                                        <i class="fas fa-leaf me-2"></i>
                                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                                    </h6>
                                    <form id="cropVerificationForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="expectedCropType" class="form-label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</label>
                                                <select class="form-select" id="expectedCropType" required>
                                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å</option>
                                                    <option value="‡∏ú‡∏±‡∏Å‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤">‡∏ú‡∏±‡∏Å‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤</option>
                                                    <option value="‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á">‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á</option>
                                                    <option value="‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®">‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®</option>
                                                    <option value="‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ">‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ</option>
                                                    <option value="‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ">‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ</option>
                                                    <option value="‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Ñ‡∏≠‡∏™">‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Ñ‡∏≠‡∏™</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="expectedCropVariety" class="form-label">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</label>
                                                <select class="form-select" id="expectedCropVariety" required>
                                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row align-items-end">
                                            <div class="col-md-8">
                                                <label for="cropVerificationSearchCode" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (SearchCode)</label>
                                                <input type="text" class="form-control form-control-lg" id="cropVerificationSearchCode" 
                                                       placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 25680920-003" 
                                                       pattern="^\d{8}-\d{3}$" required>
                                                <div class="form-text">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: YYYYMMDD-XXX
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <button type="submit" class="btn btn-warning w-100 btn-lg" style="background: linear-gradient(180deg, #f59e0b, #d97706); border: none; border-radius: 12px; padding: 1rem 1.5rem; font-weight: 700; box-shadow: 0 8px 20px rgba(245,158,11,.25); color: white;">
                                                    <i class="fas fa-search me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Production Results (Detailed Production Cycle) -->
            <div id="productionResults" class="row" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-seedling me-2"></i>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Basic Info -->
                            <div id="basicInfo" class="mb-4">
                                <h6 class="text-primary mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</strong> <span id="resultSearchCode" class="text-primary"></span></p>
                                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</strong> <span id="resultFarmerName"></span></p>
                                        <p><strong>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£:</strong> <span id="resultGroupName"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà:</strong> <span id="resultPlotNumber"></span></p>
                                        <p><strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="resultArea"></span> ‡πÑ‡∏£‡πà</p>
                                        <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <span id="resultPhone"></span></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Production Details -->
                            <div id="productionDetails" class="mb-4">
                                <h6 class="text-success mb-3"><i class="fas fa-seedling me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏ä‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä‡∏ú‡∏±‡∏Å:</strong> <span id="prodCropType"></span></p>
                                            <p><strong>‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</strong> <span id="prodCropVariety"></span></p>
                                            <p><strong>‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å:</strong> <span id="prodPlantingMethod"></span></p>
                                            <p><strong>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢:</strong> <span id="prodFertilizer"></span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÅ‡∏°‡∏•‡∏á:</strong> <span id="prodPesticide"></span></p>
                                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏≤‡∏∞‡∏õ‡∏•‡∏π‡∏Å:</strong> <span id="prodPlantDate"></span></p>
                                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</strong> <span id="prodHarvestDate"></span></p>
                                            <p><strong>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô/‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä:</strong> <span id="prodPestControl"></span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <strong>‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å:</strong> <span id="prodRecordMethod"></span>
                                    <div id="prodImages" class="mt-2">
                                        <!-- Production method images -->
                                    </div>
                                </div>
                            </div>

                            <!-- Harvest Details -->
                            <div id="harvestDetails" class="mb-4">
                                <h6 class="text-warning mb-3"><i class="fas fa-boxes me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏à‡∏∏</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</strong> <span id="harvestShipDate"></span></p>
                                            <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</strong> <span id="harvestMethod"></span></p>
                                            <p><strong>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ:</strong> <span id="harvestQuantity"></span> <span id="harvestUnit"></span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏à‡∏∏:</strong> <span id="harvestPackagingCompany"></span></p>
                                            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏:</strong> <span id="harvestPackagingLocation"></span></p>
                                            <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</strong> <span id="harvestResponsiblePerson"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Transport Details -->
                            <div id="transportDetails" class="mb-4">
                                <h6 class="text-info mb-3"><i class="fas fa-truck me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏≤‡∏£‡πå‡∏°:</strong> <span id="transportShipDate"></span></p>
                                            <p><strong>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á:</strong> <span id="transportChannel"></span></p>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="info-card">
                                            <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á:</strong> <span id="transportMethod"></span></p>
                                            <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏ô‡∏™‡πà‡∏á/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á:</strong> <span id="transportCompany"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Documents -->
                            <div id="documentsDetails" class="mb-4">
                                <h6 class="text-secondary mb-3"><i class="fas fa-images me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="info-card">
                                            <strong>‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å</strong>
                                            <div id="plotImages" class="mt-2">
                                                <!-- Plot images -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="info-card">
                                            <strong>‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</strong>
                                            <div id="productImages" class="mt-2">
                                                <!-- Product images -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="info-card">
                                            <strong>‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</strong>
                                            <div id="activityImages" class="mt-2">
                                                <!-- Activity images -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="info-card">
                                        <strong>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</strong>
                                        <div id="certificationDocs" class="mt-2">
                                            <!-- Certification documents -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info -->
                            <div id="additionalDetails" class="mb-4">
                                <h6 class="text-dark mb-3"><i class="fas fa-comment-dots me-2"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h6>
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="info-card">
                                            <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</strong>
                                            <div id="storyContent" class="mt-2">
                                                <!-- Story content -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Results -->
            <div id="noResults" class="row" style="display: none;">
                <div class="col-12 text-center">
                    <div class="card bg-light">
                        <div class="card-body py-5">
                            <i class="fas fa-search-minus fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                            <p class="text-muted">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                            <div class="mt-4">
                                <button class="btn btn-success me-2" onclick="goBackToSearch()" style="background: linear-gradient(180deg, var(--brand), var(--brand-2)); border: none; border-radius: 12px; padding: .75rem 1.5rem; font-weight: 700; box-shadow: 0 8px 20px rgba(25,135,84,.25); margin-right: 0.5rem;">
                                    <i class="fas fa-arrow-left me-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                </button>
                                <button class="btn btn-outline-secondary" onclick="location.reload()" style="border: 2px solid var(--muted); color: var(--muted); background: transparent; border-radius: 12px; font-weight: 700; padding: .75rem 1.5rem;">
                                    <i class="fas fa-refresh me-2"></i>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</span>
                    </div>
                    <p class="mt-2 mb-0">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Custom JS -->
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>

    <script>
        // ‚úÖ Enhanced JSONP Implementation with Security and Performance
        class SecureJSONP {
            constructor() {
                this.pendingRequests = new Map();
                this.requestCounter = 0;
                this.maxConcurrentRequests = 5;
                this.defaultTimeout = 30000;
                this.cleanupInterval = null;
                this.initCleanup();
            }

            initCleanup() {
                // Automatic cleanup every 2 minutes
                this.cleanupInterval = setInterval(() => {
                    this.cleanupOrphanedRequests();
                }, 120000);
            }

            async makeRequest(action, params = {}, options = {}) {
                return new Promise((resolve, reject) => {
                    // Check concurrent request limit
                    if (this.pendingRequests.size >= this.maxConcurrentRequests) {
                        reject(new Error('Too many concurrent requests. Please wait.'));
                        return;
                    }

                    const requestId = ++this.requestCounter;
                    const callbackName = `secureJSONP_${Date.now()}_${requestId}`;
                    const timeout = options.timeout || this.defaultTimeout;
                    
                    const timeoutId = setTimeout(() => {
                        this.cleanup(callbackName, script);
                        reject(new Error('Request timeout after ' + (timeout/1000) + ' seconds'));
                    }, timeout);

                    // Store request info for tracking
                    this.pendingRequests.set(callbackName, {
                        timeoutId,
                        resolve,
                        reject,
                        timestamp: Date.now(),
                        action: action
                    });

                    // Create secure callback with validation
                    window[callbackName] = (response) => {
                        const requestInfo = this.pendingRequests.get(callbackName);
                        if (!requestInfo) {
                            console.warn('üö´ Orphaned JSONP callback:', callbackName);
                            return;
                        }

                        clearTimeout(requestInfo.timeoutId);
                        this.cleanup(callbackName, script);

                        // Enhanced response validation
                        try {
                            if (this.validateResponse(response, action)) {
                                // console.log('‚úÖ JSONP Response validated successfully');
                                requestInfo.resolve(response);
                            } else {
                                requestInfo.reject(new Error('Invalid response format or data'));
                            }
                        } catch (error) {
                            console.error('‚ùå Response validation error:', error);
                            requestInfo.reject(error);
                        }
                    };

                    // Create script element with enhanced security
                    const script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.async = true;
                    script.defer = true;
                    
                    // Build secure URL with validation
                    try {
                        const url = this.buildSecureURL(action, params, callbackName);
                        script.src = url;
                        // console.log('üöÄ JSONP Request URL built successfully');
                    } catch (error) {
                        this.cleanup(callbackName, script);
                        reject(error);
                        return;
                    }
                    
                    script.onerror = (error) => {
                        console.error('‚ùå JSONP Script Load Error:', error);
                        const requestInfo = this.pendingRequests.get(callbackName);
                        if (requestInfo) {
                            clearTimeout(requestInfo.timeoutId);
                            this.cleanup(callbackName, script);
                            requestInfo.reject(new Error('Network error: Unable to load script'));
                        }
                    };

                    script.onload = () => {
                        // console.log('üì° JSONP Script loaded successfully');
                    };

                    document.head.appendChild(script);
                });
            }

            buildSecureURL(action, params, callback) {
                const baseUrl = CONFIG.API_BASE_URL;
                
                // Enhanced URL validation
                if (!baseUrl || typeof baseUrl !== 'string') {
                    throw new Error('Invalid API base URL configuration');
                }
                
                if (!baseUrl.startsWith('https://')) {
                    throw new Error('API URL must use HTTPS for security');
                }

                try {
                    new URL(baseUrl); // Validate URL format
                } catch (error) {
                    throw new Error('Malformed API base URL');
                }

                // Build parameters with validation
                const urlParams = new URLSearchParams();
                urlParams.append('action', action);
                urlParams.append('callback', callback);
                urlParams.append('timestamp', Date.now().toString());
                urlParams.append('nonce', this.generateNonce());

                // Add custom parameters with validation
                for (const [key, value] of Object.entries(params)) {
                    if (value !== null && value !== undefined) {
                        urlParams.append(key, String(value));
                    }
                }

                return `${baseUrl}?${urlParams.toString()}`;
            }

            validateResponse(response, expectedAction) {
                // Basic structure validation
                if (!response || typeof response !== 'object') {
                    console.error('‚ùå Response validation failed: Invalid object');
                    return false;
                }
                
                if (typeof response.success !== 'boolean') {
                    console.error('‚ùå Response validation failed: Missing success field');
                    return false;
                }

                // Action-specific validation
                if (expectedAction === 'searchQRCode') {
                    return this.validateQRSearchResponse(response);
                }
                
                return true; // Default validation passes
            }

            validateQRSearchResponse(response) {
                if (response.success && response.data) {
                    const requiredFields = ['plotNumber', 'farmerName', 'phone', 'address'];
                    const hasAllFields = requiredFields.every(field => {
                        const hasField = response.data.hasOwnProperty(field) && 
                                       response.data[field] !== null && 
                                       response.data[field] !== undefined &&
                                       response.data[field] !== '';
                        if (!hasField) {
                            console.warn(`‚ö†Ô∏è Missing or empty required field: ${field}`);
                        }
                        return hasField;
                    });
                    
                    if (!hasAllFields) {
                        console.error('‚ùå QR Search response validation failed: Missing required fields');
                        return false;
                    }

                    // Validate data types
                    if (typeof response.data.farmerName !== 'string' || 
                        typeof response.data.phone !== 'string' ||
                        typeof response.data.address !== 'string') {
                        console.error('‚ùå QR Search response validation failed: Invalid data types');
                        return false;
                    }

                    console.log('‚úÖ QR Search response validation passed');
                    return true;
                } else if (!response.success) {
                    // Failed responses should have a message
                    return typeof response.message === 'string';
                }
                
                return false;
            }

            generateNonce() {
                // Generate cryptographically secure nonce
                if (window.crypto && window.crypto.getRandomValues) {
                    const array = new Uint8Array(16);
                    window.crypto.getRandomValues(array);
                    return btoa(String.fromCharCode.apply(null, array))
                        .replace(/[^a-zA-Z0-9]/g, '')
                        .substr(0, 16);
                } else {
                    // Fallback for older browsers
                    return Math.random().toString(36).substr(2, 16);
                }
            }

            cleanup(callbackName, script) {
                // Remove callback function
                if (window[callbackName]) {
                    try {
                        delete window[callbackName];
                    } catch (error) {
                        window[callbackName] = undefined;
                    }
                }
                
                // Remove script element
                if (script && script.parentNode) {
                    try {
                        script.parentNode.removeChild(script);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Failed to remove script element:', error);
                    }
                }
                
                // Remove from pending requests
                this.pendingRequests.delete(callbackName);
            }

            cleanupOrphanedRequests(maxAge = 300000) { // 5 minutes default
                const now = Date.now();
                let cleanedCount = 0;
                
                for (const [callbackName, requestInfo] of this.pendingRequests.entries()) {
                    if (now - requestInfo.timestamp > maxAge) {
                        console.warn(`üßπ Cleaning up orphaned request: ${callbackName} (${requestInfo.action})`);
                        clearTimeout(requestInfo.timeoutId);
                        this.cleanup(callbackName);
                        requestInfo.reject(new Error('Request expired during cleanup'));
                        cleanedCount++;
                    }
                }
                
                if (cleanedCount > 0) {
                    console.log(`üßπ Cleaned up ${cleanedCount} orphaned requests`);
                }
            }

            getStats() {
                return {
                    pendingRequests: this.pendingRequests.size,
                    totalRequests: this.requestCounter,
                    oldestRequest: this.pendingRequests.size > 0 ? 
                        Math.min(...Array.from(this.pendingRequests.values()).map(r => r.timestamp)) : null
                };
            }

            destroy() {
                // Clean up all pending requests
                for (const [callbackName, requestInfo] of this.pendingRequests.entries()) {
                    clearTimeout(requestInfo.timeoutId);
                    this.cleanup(callbackName);
                    requestInfo.reject(new Error('SecureJSONP instance destroyed'));
                }
                
                // Clear cleanup interval
                if (this.cleanupInterval) {
                    clearInterval(this.cleanupInterval);
                }
                
                console.log('üóëÔ∏è SecureJSONP instance destroyed');
            }
        }

        // ‚úÖ Feature Toggle Configuration
        const ENHANCED_JSONP_CONFIG = {
            enabled: true, // Main toggle
            debug: true, // Enable debug logging
            maxRetries: 2, // Auto-retry failed requests
            fallbackToLegacy: true, // Fallback to legacy JSONP if enhanced fails
            enableForRoles: ['admin', 'group', 'farmer', 'public'], // Enable for all roles
            emergencyDisable: false // Emergency disable switch
        };

        // Initialize Enhanced JSONP (singleton)
        let secureJSONPInstance = null;

        function getSecureJSONPInstance() {
            if (!secureJSONPInstance && ENHANCED_JSONP_CONFIG.enabled && !ENHANCED_JSONP_CONFIG.emergencyDisable) {
                secureJSONPInstance = new SecureJSONP();
                console.log('üöÄ Enhanced JSONP initialized successfully');
            }
            return secureJSONPInstance;
        }

        // Enhanced error handler with better user feedback
        function handleSearchError(error, qrCode) {
            console.error('üö´ Simple Search Error:', error);
            
            let userMessage = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            
            // Simple error categorization
            if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                userMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
            } else if (error.message.includes('timeout')) {
                userMessage = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            } else if (error.message.includes('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö')) {
                userMessage = error.message; // Show validation errors directly
            }
            
            showAlert('error', userMessage);
            showNoResults();
        }
        
        // Keep legacy function for backward compatibility
        function handleEnhancedSearchError(error, qrCode) {
            // Redirect to simple error handler
            handleSearchError(error, qrCode);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeSearch();
            enhanceUserInterface();
        });

        function initializeSearch() {
            // Handle QR Code search form
            const qrCodeSearchForm = document.getElementById('qrCodeSearchForm');
            if (qrCodeSearchForm) {
                qrCodeSearchForm.addEventListener('submit', handleQRCodeSearchSubmit);
            }

            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const qr = urlParams.get('qr');

            if (code || qr) {
                const qrCode = code || qr;
                // Hide search section and perform QR search
                hideQRSearchSection();
                performQRCodeSearch(qrCode);
            }
        }

        function handleQRCodeSearchSubmit(e) {
            e.preventDefault();
            
            const qrCode = document.getElementById('qrCodeInput').value.trim();
            if (!qrCode) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ QR Code');
                focusQRInput();
                return;
            }

            // ‚úÖ Enhanced QR code validation
            try {
                const validation = validateEnhancedQRCode(qrCode);
                // console.log('‚úÖ QR Code validation passed:', validation);
                
                // Only hide search section if validation passes
                hideQRSearchSection();
                performQRCodeSearch(qrCode);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è QR Code validation failed:', error.message);
                showAlert('warning', error.message);
                focusQRInput();
            }
        }

        // ‚úÖ Simplified QR Code validation (format only)
        function validateEnhancedQRCode(qrCode) {
            // Basic format check only - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
            const qrPattern = /^(\d{2})-(\d{17})$/;
            const match = qrCode.match(qrPattern);
            
            if (!match) {
                throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö QR Code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô XX-XXXXXXXXXXXXXXXXX (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ -, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 17 ‡∏´‡∏•‡∏±‡∏Å)');
            }
            
            const groupCode = match[1];
            const plotNumber = match[2];
            
            // Validate Group Code (01-99) - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
            const groupNum = parseInt(groupCode);
            if (groupNum < 1 || groupNum > 99) {
                throw new Error('‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 01-99 (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å)');
            }
            
            // Validate Plot Number (not all zeros) - ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏Ñ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (plotNumber === '00000000000000000') {
                throw new Error('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç 0 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ)');
            }
            
            // ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏µ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Database ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢
            // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ Backend ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô
            
            return { 
                groupCode, 
                plotNumber, 
                isValid: true,
                groupNumber: groupNum
            };
        }

        // ‚úÖ Helper function to focus QR input
        function focusQRInput() {
            const input = document.getElementById('qrCodeInput');
            if (input) {
                input.focus();
                input.select();
            }
        }

        function hideQRSearchSection() {
            const searchSection = document.getElementById('qrSearchSection');
            if (searchSection) {
                searchSection.style.display = 'none';
            }
        }

        function showQRSearchSection() {
            const searchSection = document.getElementById('qrSearchSection');
            if (searchSection) {
                searchSection.style.display = 'block';
            }
        }

        async function handleSearchCodeSubmit(e) {
            e.preventDefault();
            
            const searchCode = document.getElementById('productionSearchInput').value.trim();
            if (!searchCode) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                return;
            }

            // Validate search code format
            const searchPattern = /^\d{8}-\d{3}$/;
            if (!searchPattern.test(searchCode)) {
                showAlert('warning', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYYMMDD-XXX');
                return;
            }

            await performSearchCodeSearch(searchCode);
        }

        async function handleDateDistributorSubmit(e) {
            e.preventDefault();
            
            const shipDate = document.getElementById('shipDateSearch').value;
            const distributorCode = document.getElementById('distributorSelect').value;

            if (!shipDate || !distributorCode) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Generate search code
            const searchCode = toBuddhistYMD(shipDate) + '-' + distributorCode;
            document.getElementById('productionSearchInput').value = searchCode;
            
            await performSearchCodeSearch(searchCode);
        }

        async function performQRCodeSearch(qrCode) {
            try {
                // console.log('üîç Starting Simple QR Code search for:', qrCode);
                showLoading(true);
                hideAllResults();

                // ‚ú® Simple & Reliable: Use standard API call
                const result = await QRAPI.searchByQRCode(qrCode);
                // console.log('üì• Simple QR API Response:', result);

                if (result.success && result.data) {
                    // console.log('‚úÖ QR Code found - displaying farmer info');
                    
                    // Store QR Code data
                    currentQRData = {
                        ...result.data,
                        qrCode: qrCode,
                        searchTimestamp: new Date().toISOString(),
                        searchMethod: 'simple-api'
                    };
                    // console.log('üíæ Stored currentQRData:', currentQRData);
                    
                    displayQRResults(result.data);
                    setupProductionFormBasedOnData(result.data);
                } else {
                    console.log('‚ùå QR Code not found');
                    showNoResults();
                    showAlert('info', result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö QR Code ‡∏ô‡∏µ‡πâ');
                }

            } catch (error) {
                console.error('‚ùå Simple QR search error:', error);
                handleSearchError(error, qrCode);
            } finally {
                showLoading(false);
            }
        }

        // ‚ùå DEPRECATED: Enhanced QR Code Search with intelligent fallback
        // This function is no longer used - replaced with simple API calls
        async function performEnhancedQRCodeSearch(qrCode) {
            const instance = getSecureJSONPInstance();
            
            if (instance && ENHANCED_JSONP_CONFIG.enabled) {
                try {
                    console.log('üöÄ Using Enhanced JSONP for QR search');
                    return await instance.makeRequest('searchQRCode', {
                        qrCode: qrCode,
                        format: 'json',
                        version: '2.0',
                        clientInfo: {
                            userAgent: navigator.userAgent.substring(0, 100),
                            timestamp: new Date().toISOString(),
                            screenResolution: `${screen.width}x${screen.height}`
                        }
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è Enhanced JSONP failed:', error.message);
                    
                    // Intelligent fallback decision
                    if (ENHANCED_JSONP_CONFIG.fallbackToLegacy) {
                        console.log('üîÑ Falling back to legacy JSONP method');
                        return await performLegacyQRCodeSearchJSONP(qrCode);
                    } else {
                        throw error;
                    }
                }
            } else {
                console.log('üì± Enhanced JSONP disabled, using legacy method');
                return await performLegacyQRCodeSearchJSONP(qrCode);
            }
        }

        // ‚úÖ Legacy JSONP method (renamed for backward compatibility)
        async function performLegacyQRCodeSearchJSONP(qrCode) {
            return new Promise((resolve, reject) => {
                const callbackName = 'qrCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const timeoutDuration = 30000; // 30 seconds
                let timeoutId;
                let script;
                
                // Cleanup function
                const cleanup = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    if (window[callbackName]) delete window[callbackName];
                    if (script && script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                };
                
                // Create JSONP callback
                window[callbackName] = function(response) {
                    console.log('üì• JSONP Response received:', response);
                    cleanup();
                    resolve(response);
                };
                
                // Create script element for JSONP
                script = document.createElement('script');
                script.async = true;
                script.defer = true;
                
                // Use current API_BASE_URL from CONFIG
                const baseUrl = CONFIG.API_BASE_URL;
                const url = `${baseUrl}?action=searchQRCode&qrCode=${encodeURIComponent(qrCode)}&callback=${callbackName}&timestamp=${Date.now()}`;
                
                console.log('üöÄ JSONP Request URL:', url);
                
                script.src = url;
                script.onerror = function(error) {
                    console.error('‚ùå JSONP Script Error:', error);
                    cleanup();
                    reject(new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'));
                };
                
                // Set timeout
                timeoutId = setTimeout(() => {
                    console.warn('‚è∞ JSONP Request timeout after 30 seconds');
                    cleanup();
                    reject(new Error('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'));
                }, timeoutDuration);
                
                // Add script to head to execute
                document.head.appendChild(script);
            });
        }

        // Legacy GET method for backward compatibility
        async function performQRCodeSearchGET(qrCode) {
            console.warn('‚ö†Ô∏è Using legacy GET method, consider using JSONP instead');
            return performQRCodeSearchJSONP(qrCode);
        }

        // Store current QR data for validation
        let currentQRData = null;

        async function performSearchCodeSearch(searchCode) {
            try {
                console.log('üîç Starting Simple SearchCode search for:', searchCode);
                showLoading(true);
                
                // Validate input first
                if (!searchCode || searchCode.trim() === '') {
                    showValidationError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï');
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' };
                }
                
                // Basic format validation only
                const cleanedSearchCode = searchCode.trim();
                if (!Utils.validateSearchCode(cleanedSearchCode)) {
                    showValidationError('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYYMMDD-XXX ‡πÄ‡∏ä‡πà‡∏ô 20241201-001)');
                    return { success: false, message: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
                }
                
                // console.log('‚úÖ SearchCode format validated:', cleanedSearchCode);
                
                // Hide only production results, keep QR results visible
                hideElement('productionResults');
                hideElement('noResults');

                // ‚ú® Simple & Reliable: Use QRAPI with proper error handling
                const result = await QRAPI.searchByDeepCode(cleanedSearchCode);
                console.log('üì• Simple SearchCode API Response:', result);

                if (result.success && result.data) {
                    // ‚úÖ Core validation: Ensure SearchCode belongs to current QR Code
                    if (currentQRData && currentQRData.qrCode) {
                        const currentQRCode = currentQRData.qrCode;
                        const searchResultQRCode = result.data.qrCode;
                        
                        console.log('üîç QR Code Matching Validation:');
                        console.log('  ‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß:', currentQRCode);
                        console.log('  ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á:', searchResultQRCode);
                        
                        if (searchResultQRCode && currentQRCode !== searchResultQRCode) {
                            console.log('‚ùå SearchCode and QRCode do not match');
                            showValidationError(`‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö QR Code ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô\n\nQR Code ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô: ${currentQRCode}\n‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á: ${searchResultQRCode}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                            return { success: false, message: 'QR Code ‡πÅ‡∏•‡∏∞ SearchCode ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô' };
                        }
                        
                        console.log('‚úÖ QR Code ‡πÅ‡∏•‡∏∞ SearchCode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    } else {
                        console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ QR Code ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SearchCode ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á');
                    }
                    
                    console.log('‚úÖ SearchCode found - displaying production results');
                    displayProductionResults(result.data);
                    
                    // Store search method for analytics
                    if (result.data) {
                        result.data.searchMethod = 'simple-search-code';
                        result.data.searchTimestamp = new Date().toISOString();
                    }
                    
                    return result; // ‚úÖ Return ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö crop verification
                    
                } else {
                    console.log('‚ùå SearchCode not found');
                    showValidationError(result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    return { success: false, message: result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ' };
                }

            } catch (error) {
                console.error('‚ùå Simple SearchCode error:', error);
                
                // Better error categorization
                let errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                
                if (error.message.includes('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö')) {
                    errorMessage = error.message; // Show validation errors directly
                } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                    errorMessage = '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                } else if (error.message.includes('timeout')) {
                    errorMessage = '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                }
                
                showValidationError(errorMessage);
                return { success: false, message: errorMessage };
            } finally {
                showLoading(false);
            }
        }

        // New function for search with crop validation using Google Apps Script
        async function performSearchCodeSearchWithCropValidation(searchCode, expectedCropType, expectedCropVariety) {
            try {
                // console.log('üå± Starting SearchCode search with crop validation in Google Sheets:', {
                    searchCode, expectedCropType, expectedCropVariety
                });
                
                // Validate input first
                if (!searchCode || searchCode.trim() === '') {
                    return { success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' };
                }
                
                // Basic format validation only
                const cleanedSearchCode = searchCode.trim();
                if (!Utils.validateSearchCode(cleanedSearchCode)) {
                    return { success: false, message: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' };
                }
                
                // console.log('‚úÖ SearchCode format validated:', cleanedSearchCode);
                
                // ‚ú® Call enhanced API with crop validation parameters
                const apiParams = {
                    expectedCropType: expectedCropType,
                    expectedCropVariety: expectedCropVariety
                };
                
                const result = await QRAPI.searchByDeepCode(cleanedSearchCode, apiParams);
                // console.log('üì• SearchCode API Response with crop validation from GAS:', result);
                
                if (result.success && result.data) {
                    // ‚úÖ QR Code validation is now handled in handleCropVerificationSubmit()
                    // This ensures better error messaging and user experience
                    
                    // ‚úÖ Check server-side crop validation results from Google Apps Script
                    // console.log('üå± Crop validation results from Google Sheets:', {
                        isValidCrop: result.isValidCrop,
                        actualCropType: result.actualCropType,
                        actualCropVariety: result.actualCropVariety,
                        expectedCropType: result.expectedCropType,
                        expectedCropVariety: result.expectedCropVariety
                    });
                    
                    // Return the complete result with crop validation info
                    return {
                        success: true,
                        data: result.data,
                        isValidCrop: result.isValidCrop,
                        actualCropType: result.actualCropType,
                        actualCropVariety: result.actualCropVariety,
                        expectedCropType: result.expectedCropType,
                        expectedCropVariety: result.expectedCropVariety,
                        matchedProductionID: result.matchedProductionID,
                        message: result.message
                    };
                    
                } else {
                    console.log('‚ùå SearchCode not found');
                    return { success: false, message: result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ' };
                }
                
            } catch (error) {
                console.error('‚ùå SearchCode with crop validation error:', error);
                return { success: false, message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + error.message };
            }
        }

        // Legacy function for backward compatibility
        async function performSearch(searchCode) {
            return await performSearchCodeSearch(searchCode);
        }

        function displayResults(data) {
            // Display basic info - Handle both PascalCase and camelCase
            document.getElementById('resultSearchCode').textContent = data.searchCode || '-';
            document.getElementById('resultFarmerName').textContent = data.farmer?.FullName || data.farmer?.fullName || '-';
            document.getElementById('resultGroupName').textContent = data.farmer?.GroupName || data.farmer?.groupName || '-';
            document.getElementById('resultPlotNumber').textContent = data.farmer?.PlotNumber || data.farmer?.plotNumber || '-';
            document.getElementById('resultArea').textContent = data.farmer?.Area || data.farmer?.area || '-';
            document.getElementById('resultPhone').textContent = data.farmer?.Phone || data.farmer?.phone || '-';

            // Display production data
            if (data.productions && data.productions.length > 0) {
                // Use the production record that matches matchedProductionID from crop validation
                // If no matchedProductionID, fall back to first record
                // console.log('üîß displayResults - matchedProductionID:', data.matchedProductionID);
                // console.log('üîß displayResults - productions count:', data.productions.length);
                
                const prod = data.matchedProductionID 
                    ? data.productions.find(p => p.ProductionID === data.matchedProductionID) || data.productions[0]
                    : data.productions[0];
                    
                // console.log('üîß displayResults - selected production:', prod.ProductionID, 'CropType:', prod.CropType);
                document.getElementById('prodCropType').textContent = prod.CropType || '-';
                document.getElementById('prodCropVariety').textContent = prod.CropVariety || '-';
                
                // Handle "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" fields - show the specific value if available
                let plantingMethod = prod.PlantingMethod || prod.plantingMethod || '-';
                if (plantingMethod === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏' && (prod.PlantingMethodOther || prod.plantingMethodOther)) {
                    plantingMethod = prod.PlantingMethodOther || prod.plantingMethodOther;
                }
                document.getElementById('prodPlantingMethod').textContent = plantingMethod;
                
                document.getElementById('prodFertilizer').textContent = prod.Fertilizer || '-';
                document.getElementById('prodPesticide').textContent = prod.Pesticide || '-';
                document.getElementById('prodPlantDate').textContent = Utils.formatDateThai(prod.PlantDate) || '-';
                document.getElementById('prodHarvestDate').textContent = Utils.formatDateThai(prod.HarvestDate) || '-';
                document.getElementById('prodPestControl').textContent = prod.PestControl || '-';
                // Set record method from database first
                const recordMethod = prod.RecordMethod || prod.recordMethod || '-';
                document.getElementById('prodRecordMethod').textContent = recordMethod;
            }

            // Display harvest data
            if (data.harvests && data.harvests.length > 0) {
                const harvest = data.harvests[0]; // Take first harvest record
                document.getElementById('harvestShipDate').textContent = Utils.formatDateThai(harvest.ShipDate) || '-';
                document.getElementById('harvestMethod').textContent = harvest.HarvestMethod || '-';
                document.getElementById('harvestQuantity').textContent = harvest.Quantity || '-';
                
                // Handle unit "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                let unit = harvest.Unit || harvest.unit || '-';
                if (unit === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏' && (harvest.UnitOther || harvest.unitOther)) {
                    unit = harvest.UnitOther || harvest.unitOther;
                }
                document.getElementById('harvestUnit').textContent = unit;
                
                document.getElementById('harvestPackagingCompany').textContent = harvest.PackagingCompany || '-';
                document.getElementById('harvestPackagingLocation').textContent = harvest.PackagingLocation || '-';
                document.getElementById('harvestResponsiblePerson').textContent = harvest.ResponsiblePerson || '-';
            }

            // Display transport data
            if (data.transports && data.transports.length > 0) {
                const transport = data.transports[0]; // Take first transport record
                // Handle different field names for ship date (farmShipDate vs ShipDate)
                const shipDate = transport.farmShipDate || transport.ShipDate || transport.shipDate;
                document.getElementById('transportShipDate').textContent = Utils.formatDateThai(shipDate) || '-';
                document.getElementById('transportChannel').textContent = transport.TransportChannel || transport.transportChannel || '-';
                
                // Handle transport method "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                let transportMethod = transport.TransportMethod || transport.transportMethod || '-';
                if (transportMethod === '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏∞‡∏ö‡∏∏' && (transport.TransportMethodOther || transport.transportMethodOther)) {
                    transportMethod = transport.TransportMethodOther || transport.transportMethodOther;
                }
                document.getElementById('transportMethod').textContent = transportMethod;
                
                document.getElementById('transportCompany').textContent = transport.TransportCompany || transport.transportCompany || '-';
            }

            // Display images from file records
            displayProductionImages(data.fileRecords);
            
            // Display production method images
            displayProductionMethodImages(data.fileRecords);
            
            // Display additional info - show only story content
            if (data.additionalInfo && data.additionalInfo.length > 0) {
                const info = data.additionalInfo[0];
                const storyContent = info.Story || info.Comments || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('storyContent').textContent = storyContent;
            } else {
                document.getElementById('storyContent').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        function displayProductionImages(fileRecords) {
            // console.log('üì∏ displayProductionImages called with:', fileRecords);
            
            // Initialize all sections first
            const sections = ['plotImages', 'productImages', 'activityImages', 'certificationDocs'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.innerHTML = '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
                }
            });
            
            if (!fileRecords || fileRecords.length === 0) {
                // console.log('‚ùå No file records found');
                return;
            }
            
            // Group files by EXACT FileType match to prevent overlap
            const plotImages = fileRecords.filter(file => {
                const fileType = file.FileType || file.fileType || '';
                return fileType === '‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏•‡∏π‡∏Å';
            });
            
            const productImages = fileRecords.filter(file => {
                const fileType = file.FileType || file.fileType || '';
                return fileType === '‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            });
            
            const activityImages = fileRecords.filter(file => {
                const fileType = file.FileType || file.fileType || '';
                return fileType === '‡∏£‡∏π‡∏õ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å';
            });
            
            const certificationDocs = fileRecords.filter(file => {
                const fileType = file.FileType || file.fileType || '';
                return fileType === '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á';
            });
            
            console.log('üìÅ Image groups (EXACT match):', { 
                plotImages: plotImages.length, 
                productImages: productImages.length, 
                activityImages: activityImages.length, 
                certificationDocs: certificationDocs.length 
            });
            
            console.log('üîç FileTypes found:', fileRecords.map(f => f.FileType || f.fileType));
            
            // Display each group
            const plotElement = document.getElementById('plotImages');
            if (plotElement) plotElement.innerHTML = displayFileList(plotImages);
            
            const productElement = document.getElementById('productImages');
            if (productElement) productElement.innerHTML = displayFileList(productImages);
            
            const activityElement = document.getElementById('activityImages');
            if (activityElement) activityElement.innerHTML = displayFileList(activityImages);
            
            const certElement = document.getElementById('certificationDocs');
            if (certElement) certElement.innerHTML = displayFileList(certificationDocs);
        }

        function displayProductionMethodImages(fileRecords) {
            const prodImagesElement = document.getElementById('prodImages');
            const prodRecordMethodElement = document.getElementById('prodRecordMethod');
            
            if (!prodImagesElement) {
                console.warn('‚ö†Ô∏è prodImages element not found');
                return;
            }
            
            if (!fileRecords || fileRecords.length === 0) {
                prodImagesElement.innerHTML = '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
                return;
            }
            
            // Filter files with EXACT FileType = "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å"
            const methodImages = fileRecords.filter(file => {
                const fileType = file.FileType || file.fileType || '';
                return fileType === '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å';
            });
            
            console.log('üå± Production method images (EXACT match):', methodImages.length);
            console.log('üå± Method images data:', methodImages);
            
            // Update record method text based on files
            if (methodImages.length > 0) {
                // If there are method images, show "manual" regardless of database value
                if (prodRecordMethodElement) {
                    prodRecordMethodElement.textContent = 'manual';
                }
                // Display the images
                prodImagesElement.innerHTML = displayFileList(methodImages);
            } else {
                // No method images - keep the database value and show "no files"
                prodImagesElement.innerHTML = '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
            }
        }
        
        function displayFileList(files) {
            if (!files || files.length === 0) {
                return '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
            }
            
            return files.map(file => {
                try {
                    // Handle both property names (FileUrl/fileUrl, FileName/fileName, etc.)
                    const fileUrl = file.FileUrl || file.fileUrl || file.DownloadUrl || file.downloadUrl || '';
                    let fileName = file.FileName || file.fileName || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå';
                    
                    // Clean filename - remove prefix patterns
                    fileName = fileName.replace(/^[^_]*_/, ''); // Remove "productionId_" prefix
                    fileName = fileName.replace(/^'/, ''); // Remove leading quote
                    
                    console.log('üîó Processing file:', { fileName, fileUrl, fileType: file.FileType || file.fileType });
                    
                    if (fileUrl) {
                        return `<div class="mb-1">
                            <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>${fileName}
                            </a>
                        </div>`;
                    } else {
                        return `<div class="mb-1">
                            <span class="text-muted">${fileName} (‡πÑ‡∏°‡πà‡∏°‡∏µ URL)</span>
                        </div>`;
                    }
                } catch (error) {
                    console.error('‚ùå Error processing file:', file, error);
                    return `<div class="mb-1">
                        <span class="text-muted">‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
                    </div>`;
                }
            }).join('');
        }

        function displayFarmerImages(farmerData) {
            // Legacy function - kept for backward compatibility
            const plotImagesContainer = document.getElementById('plotImages');
            plotImagesContainer.innerHTML = displayImageList(farmerData?.PlotImages || '');
            
            const productImagesContainer = document.getElementById('productImages');
            productImagesContainer.innerHTML = displayImageList(farmerData?.ProductImages || '');
            
            const activityImagesContainer = document.getElementById('activityImages');
            activityImagesContainer.innerHTML = displayImageList(farmerData?.ActivityImages || '');
            
            const certificationDocsContainer = document.getElementById('certificationDocs');
            certificationDocsContainer.innerHTML = displayImageList(farmerData?.CertificationDocs || '');
        }

        function displayImageList(imageData) {
            if (!imageData) return '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
            
            // Split by comma if multiple URLs
            const images = imageData.split(',').filter(url => url.trim());
            if (images.length === 0) return '<small class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>';
            
            return images.map(imageUrl => {
                const cleanUrl = imageUrl.trim();
                return `<img src="${cleanUrl}" class="img-thumbnail me-2 mb-2" style="width: 60px; height: 60px; cursor: pointer;" onclick="window.open('${cleanUrl}', '_blank')">`;
            }).join('');
        }

        function getDistributorName(code) {
            const distributors = {
                '001': '001 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Ñ‡∏¥‡∏á‡∏™‡πå ‡∏ß‡∏¥‡∏ä ‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',
                '002': '002 ‡∏´‡∏à‡∏Å. ‡∏ò‡∏≤‡∏ß‡∏¥‡∏ô‡πÄ‡∏ü‡∏£‡∏ä',
                '003': '003 ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ü‡∏≤‡∏£‡πå‡∏° ‡∏™‡πÄ‡∏ï‡∏ä‡∏±‡πà‡∏ô ‡∏à‡∏≥‡∏Å‡∏±‡∏î'
            };
            return distributors[code] || code;
        }

        function displayQRResults(data) {
            // console.log('üìã Displaying QR results:', data);
            
            // Store current QR data for validation - ensure farmerName is available
            currentQRData = {
                ...data,
                farmerName: data.farmerName || data.farmer?.FullName || data.farmer?.fullName || ''
            };
            
            console.log('üíæ Stored currentQRData for validation:', currentQRData);
            
            // Show QR results section
            showElement('qrResults');
            hideElement('productionResults');
            hideElement('noResults');

            // Display farmer info with enhanced formatting
            setElementText('qrPlotNumber', data.plotNumber);
            setElementText('qrFarmerName', data.farmerName);
            setElementText('qrFarmerPhone', data.phone);
            setElementText('qrFarmerAddress', data.address);
            setElementText('qrFarmerArea', data.area + ' ‡πÑ‡∏£‡πà');
            
            console.log(`üìä Farmer has ${data.searchCodesCount || 0} search codes available`);
            
            // Show success message for QR scan
            showAlert('info', `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ${data.farmerName} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        function displayProductionResults(data) {
            // Legacy function - redirect to new showProductionResults()
            showProductionResults(data);
        }

        // Simplified helper functions
        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'none';
        }
        
        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.style.display = 'block';
        }
        
        function setElementText(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) element.textContent = value || '-';
        }

        // New streamlined setup function
        function setupProductionFormBasedOnData(data) {
            console.log('üîß Setting up production form based on data:', data);
            console.log('üîç Checking if hasSearchCodes exists:', 'hasSearchCodes' in data);
            
            // Check if new API format (with hasSearchCodes)
            if ('hasSearchCodes' in data) {
                console.log('üì° Using new API format');
                if (data.hasSearchCodes) {
                    console.log(`‚úÖ Found ${data.searchCodesCount} search codes - showing form`);
                    showProductionSearchForm();
                    
                    if (data.availableSearchCodes && data.availableSearchCodes.length > 0) {
                        populateSearchCodeDropdown(data.availableSearchCodes);
                    }
                } else {
                    console.log('‚ùå No search codes found - showing warning');
                    showProductionMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ô‡∏µ‡πâ');
                }
            } else {
                console.log('üì° Using old API format - checking manually');
                // Fallback: Check manually with separate API call
                checkSearchCodesManually(data.qrCode || `${data.groupCode}-${data.plotNumber}`);
            }
        }
        
        async function checkSearchCodesManually(qrCode) {
            try {
                console.log('üîç Manual check for search codes:', qrCode);
                const response = await API.call('checkSearchCodes', { qrCode: qrCode });
                console.log('üìä Manual check response:', response);
                
                if (response.success && response.hasSearchCodes) {
                    console.log(`‚úÖ Manual check: Found ${response.count} search codes`);
                    showProductionSearchForm();
                } else {
                    console.log('‚ùå Manual check: No search codes found');
                    showProductionMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ô‡∏µ‡πâ');
                }
            } catch (error) {
                console.error('‚ùå Manual check failed:', error);
                console.log('üìù Fallback: Showing form due to error');
                showProductionSearchForm();
            }
        }
        
        function populateSearchCodeDropdown(searchCodes) {
            // Optional: Add dropdown for available search codes
            const input = document.getElementById('productionSearchInput');
            if (input && searchCodes.length === 1) {
                // If only one search code, auto-populate
                input.placeholder = `‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ${searchCodes[0].searchCode}`;
            }
        }
        
        function showProductionSearchForm() {
            const formContainer = document.querySelector('#qrResults .card.bg-light');
            if (formContainer) {
                formContainer.style.display = 'block';
            }
        }
        
        function hideProductionSearchForm() {
            const formContainer = document.querySelector('#qrResults .card.bg-light');
            if (formContainer) {
                formContainer.style.display = 'none';
            }
        }
        
        function showProductionMessage(message) {
            const formContainer = document.querySelector('#qrResults .card.bg-light');
            if (formContainer) {
                formContainer.innerHTML = `
                    <div class="card-body">
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                        <div class="mt-3 text-center">
                            <button class="btn btn-outline-success" onclick="location.reload()" style="border: 2px solid var(--brand); color: var(--brand); background: transparent; border-radius: 12px; font-weight: 700; padding: .75rem 1.5rem;">
                                <i class="fas fa-refresh me-2"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà
                            </button>
                        </div>
                    </div>
                `;
                formContainer.style.display = 'block';
            }
        }


        function hideAllResults() {
            const elements = ['qrResults', 'productionResults', 'searchResults', 'noResults'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
        }

        function hideResults() {
            hideAllResults();
        }

        function showNoResults() {
            hideAllResults();
            const noResults = document.getElementById('noResults');
            if (noResults) {
                noResults.style.display = 'block';
            }
        }

        function fillSearchCode(code) {
            // Fill crop verification search code input if it exists
            const cropVerificationInput = document.getElementById('cropVerificationSearchCode');
            
            if (cropVerificationInput) {
                cropVerificationInput.value = code;
            }
        }

        function showLoading(show) {
            const modal = document.getElementById('loadingModal');
            if (!modal) {
                console.warn('Loading modal element not found');
                return;
            }
            
            if (show) {
                try {
                    // ‚ú® FIX: Properly handle aria-hidden to avoid accessibility warnings
                    modal.removeAttribute('aria-hidden');
                    modal.setAttribute('aria-modal', 'true');
                    
                    // Check if Bootstrap is loaded
                    if (typeof bootstrap !== 'undefined') {
                        const modalInstance = new bootstrap.Modal(modal, {
                            backdrop: 'static',
                            keyboard: false
                        });
                        modalInstance.show();
                    } else {
                        // Fallback: show modal manually
                        modal.style.display = 'block';
                        modal.classList.add('show');
                        document.body.classList.add('modal-open');
                        document.body.style.overflow = 'hidden';
                    }
                } catch (error) {
                    console.error('Error showing loading modal:', error);
                    // Enhanced fallback
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    modal.removeAttribute('aria-hidden');
                    modal.setAttribute('aria-modal', 'true');
                }
            } else {
                try {
                    // ‚ú® FIX: Properly handle hiding and cleanup
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    
                    if (typeof bootstrap !== 'undefined') {
                        const instance = bootstrap.Modal.getInstance(modal);
                        if (instance) {
                            instance.hide();
                        }
                    } else {
                        // Enhanced fallback: hide modal manually
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        
                        // Remove backdrop if it exists
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                } catch (error) {
                    console.error('Error hiding loading modal:', error);
                    // Enhanced fallback
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    
                    // Force remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }
            }
        }

        function showAlert(type, message) {
            // Enhanced alert system with better UX
            console.log(`Alert [${type}]:`, message);
            
            // Create or update alert element
            let alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
                document.body.appendChild(alertContainer);
            }
            
            const alertClass = type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-info';
            const iconClass = type === 'error' ? 'fas fa-exclamation-circle' : type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show shadow" role="alert">
                    <i class="${iconClass} me-2"></i>
                    <strong>${type === 'error' ? '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!' : type === 'warning' ? '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            // Auto dismiss based on type
            const dismissTime = type === 'error' ? 8000 : type === 'warning' ? 6000 : 4000;
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 150);
                }
            }, dismissTime);
        }
        
        function showValidationError(message) {
            // Specialized function for validation errors that keeps user in QR search section
            console.log('üö´ Validation Error:', message);
            showAlert('warning', message);
            
            // Keep focus on search code input for retry
            const searchInput = document.getElementById('productionSearchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }
        
        function clearSearchCodeInput() {
            const searchInput = document.getElementById('productionSearchInput');
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
        }
        
        function goBackToSearch() {
            // Clear all results and return to QR search
            hideAllResults();
            showQRSearchSection();
            
            // Clear inputs
            const qrInput = document.getElementById('qrCodeInput');
            const searchInput = document.getElementById('productionSearchInput');
            
            if (qrInput) {
                qrInput.value = '';
                qrInput.focus();
            }
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Reset current QR data
            currentQRData = null;
            
            console.log('üîÑ Reset to initial search state');
        }
        
        function enhanceUserInterface() {
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // ESC key to go back to search
                if (e.key === 'Escape') {
                    goBackToSearch();
                }
                
                // Ctrl+/ to focus on QR input
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    const qrInput = document.getElementById('qrCodeInput');
                    if (qrInput) qrInput.focus();
                }
                
                // Enter key on QR input
                if (e.key === 'Enter' && e.target.id === 'qrCodeInput') {
                    e.preventDefault();
                    const form = document.getElementById('qrCodeSearchForm');
                    if (form) form.dispatchEvent(new Event('submit'));
                }
            });
            
            // ‚úÖ Enhanced input validation with real-time feedback
            const qrInput = document.getElementById('qrCodeInput');
            if (qrInput) {
                // Real-time validation feedback
                qrInput.addEventListener('input', function(e) {
                    const value = e.target.value;
                    clearTimeout(this.validationTimeout);
                    
                    // Remove existing feedback
                    e.target.classList.remove('border-warning', 'border-success', 'border-danger');
                    const feedback = e.target.parentNode.querySelector('.validation-feedback');
                    if (feedback) feedback.remove();
                    
                    if (!value) return;
                    
                    // Delayed validation to avoid too many checks while typing
                    this.validationTimeout = setTimeout(() => {
                        try {
                            validateEnhancedQRCode(value);
                            e.target.classList.add('border-success');
                            showInputFeedback(e.target, '‚úÖ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö QR Code ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'success');
                        } catch (error) {
                            e.target.classList.add('border-warning');
                            showInputFeedback(e.target, '‚ö†Ô∏è ' + error.message, 'warning');
                        }
                    }, 500);
                });

                // ‚úÖ Enhanced paste handling
                qrInput.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        const value = e.target.value.trim();
                        if (value) {
                            // Auto-format common QR code patterns
                            let formattedValue = value;
                            
                            // Remove any non-digit and non-dash characters
                            formattedValue = formattedValue.replace(/[^\d-]/g, '');
                            
                            // Add dash if missing (for 19-digit numbers)
                            if (/^\d{19}$/.test(formattedValue)) {
                                formattedValue = formattedValue.substring(0, 2) + '-' + formattedValue.substring(2);
                            }
                            
                            if (formattedValue !== value) {
                                e.target.value = formattedValue;
                                showInputFeedback(e.target, 'üîß ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥', 'info');
                            }
                        }
                    }, 10);
                });

                // ‚úÖ Focus management
                qrInput.addEventListener('focus', function(e) {
                    e.target.select();
                });
            }

            // ‚úÖ Enhanced loading states
            const originalShowLoading = showLoading;
            window.showLoading = function(show, message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...') {
                const modal = document.getElementById('loadingModal');
                if (modal) {
                    const messageEl = modal.querySelector('p');
                    if (messageEl) messageEl.textContent = message;
                }
                return originalShowLoading(show);
            };

            // ‚úÖ Add performance monitoring
            if (ENHANCED_JSONP_CONFIG.debug) {
                // console.log('üé® Enhanced UI features initialized');
                
                // Monitor JSONP performance
                setInterval(() => {
                    const instance = getSecureJSONPInstance();
                    if (instance) {
                        const stats = instance.getStats();
                        if (stats.pendingRequests > 0) {
                            console.log('üìä JSONP Stats:', stats);
                        }
                    }
                }, 30000); // Every 30 seconds
            }
        }

        // ‚úÖ Helper function to show input validation feedback
        function showInputFeedback(inputElement, message, type = 'info') {
            // Remove existing feedback
            const existingFeedback = inputElement.parentNode.querySelector('.validation-feedback');
            if (existingFeedback) existingFeedback.remove();
            
            // Create new feedback element
            const feedback = document.createElement('div');
            feedback.className = `validation-feedback text-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} small mt-1`;
            feedback.textContent = message;
            
            // Insert after input
            inputElement.parentNode.appendChild(feedback);
            
            // Auto-remove positive feedback after 3 seconds
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.remove();
                    }
                }, 3000);
            }
        }

        // ========================================
        // üå± CROP VERIFICATION FUNCTIONALITY
        // ========================================

        // Master data for crop types and varieties (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)
        const CROP_MASTER_DATA = {
            '‡∏ú‡∏±‡∏Å‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤': ['‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏ô', '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏î‡∏´‡∏≠‡∏°'],
            '‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á': ['‡∏ï‡πâ‡∏ô', '‡∏Æ‡πà‡∏≠‡∏á‡πÄ‡∏ï‡πâ'],
            '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®': ['‡∏ó‡πâ‡∏≠', '‡∏£‡∏≤‡∏ä‡∏¥‡∏ô‡∏µ'],
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ': [],
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ': [],
            '‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î‡∏Ñ‡∏≠‡∏™': []
        };

        // Initialize crop verification functionality
        function initializeCropVerification() {
            const cropTypeSelect = document.getElementById('expectedCropType');
            const cropVarietySelect = document.getElementById('expectedCropVariety');
            const cropVerificationForm = document.getElementById('cropVerificationForm');

            if (!cropTypeSelect || !cropVarietySelect || !cropVerificationForm) {
                console.warn('üå± Crop verification elements not found');
                return;
            }

            // Handle crop type selection change
            cropTypeSelect.addEventListener('change', function() {
                const selectedCropType = this.value;
                populateCropVarieties(selectedCropType, cropVarietySelect);
            });

            // Handle crop verification form submission
            cropVerificationForm.addEventListener('submit', handleCropVerificationSubmit);

            // console.log('üå± Crop verification initialized successfully');
        }

        // Populate crop varieties based on selected crop type
        function populateCropVarieties(cropType, varietySelect) {
            // Clear existing options
            varietySelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</option>';

            if (cropType && CROP_MASTER_DATA[cropType]) {
                const varieties = CROP_MASTER_DATA[cropType];
                
                if (varieties.length > 0) {
                    // ‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå
                    varieties.forEach(variety => {
                        const option = document.createElement('option');
                        option.value = variety;
                        option.textContent = variety;
                        varietySelect.appendChild(option);
                    });
                    varietySelect.disabled = false;
                    varietySelect.required = true;
                    console.log(`üå± Populated ${varieties.length} varieties for ${cropType}`);
                } else {
                    // ‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå - ‡πÄ‡∏û‡∏¥‡πà‡∏° option "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå"
                    const option = document.createElement('option');
                    option.value = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå';
                    option.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå';
                    option.selected = true;
                    varietySelect.appendChild(option);
                    varietySelect.disabled = true;
                    varietySelect.required = false;
                    console.log(`üå± ${cropType} ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`);
                }
            } else {
                varietySelect.disabled = true;
                varietySelect.required = true;
                console.log('üå± No varieties available for selected crop type');
            }
        }

        // Handle crop verification form submission
        async function handleCropVerificationSubmit(e) {
            e.preventDefault();
            
            const expectedCropType = document.getElementById('expectedCropType').value.trim();
            const expectedCropVariety = document.getElementById('expectedCropVariety').value.trim();
            const searchCode = document.getElementById('cropVerificationSearchCode').value.trim();

            // Step 1: Validate QR Code requirement first
            if (!currentQRData || !currentQRData.qrCode) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï\n\n‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:\n1. ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå\n3. ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï');
                return;
            }

            // Step 2: Validate form inputs
            if (!expectedCropType) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å');
                return;
            }

            if (!expectedCropVariety) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå');
                return;
            }

            if (!searchCode) {
                showAlert('warning', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï');
                return;
            }

            // Step 3: Validate SearchCode format
            const searchPattern = /^\d{8}-\d{3}$/;
            if (!searchPattern.test(searchCode)) {
                showAlert('error', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYYMMDD-XXX');
                return;
            }

            // console.log('üå± Starting crop verification process:', {
                expectedCropType,
                expectedCropVariety,
                searchCode,
                currentQRCode: currentQRData.qrCode
            });

            // Step 4: Perform SearchCode lookup with crop validation
            showLoading(true);

            try {
                // Perform search with crop validation parameters
                const result = await performSearchCodeSearchWithCropValidation(searchCode, expectedCropType, expectedCropVariety);
                
                // Step 5: Check if SearchCode belongs to current QR Code (‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
                if (result.success && result.data && result.data.qrCode) {
                    if (currentQRData.qrCode !== result.data.qrCode) {
                        showLoading(false); // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô return
                        setTimeout(() => {
                            showQRCodeMismatchError(currentQRData.qrCode, result.data.qrCode, searchCode);
                        }, 100);
                        return;
                    }
                    console.log('‚úÖ QR Code ‡πÅ‡∏•‡∏∞ SearchCode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                }
                
                // Step 6: Check other errors
                if (!result.success) {
                    showLoading(false); // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô return
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ modal ‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á error
                    setTimeout(() => {
                        showAlert('error', result.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ');
                    }, 100);
                    return;
                }

                // Step 7: Check crop validation result from Google Sheets
                if (result.isValidCrop !== null && !result.isValidCrop) {
                    showLoading(false); // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô return
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ modal ‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á error
                    setTimeout(() => {
                        showCropValidationErrorFromGAS(result, expectedCropType, expectedCropVariety);
                    }, 100);
                    return;
                }

                // Step 8: If all validations pass, display results
                const successMessage = result.isValidCrop ? 
                    `‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                    `üå± ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${expectedCropType}\n` +
                    `üåø ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${expectedCropVariety}\n` +
                    `üì± QR Code: ${currentQRData.qrCode}\n` +
                    `üîç ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï: ${searchCode}\n\n` +
                    `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö` :
                    `‚úÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                    
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î modal
                // üîß FIXED: Add matchedProductionID to data before passing to showProductionResults
                if (result.matchedProductionID) {
                    result.data.matchedProductionID = result.matchedProductionID;
                }
                showProductionResults(result.data);
                showAlert('success', successMessage);

            } catch (error) {
                console.error('‚ùå Crop verification error:', error);
                showLoading(false); // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á error
                setTimeout(() => {
                    showAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + error.message);
                }, 100);
            } finally {
                showLoading(false); // ‚úÖ Backup - ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô catch
            }
        }

        // Validate crop type and variety match
        function validateCropMatch(searchData, expectedCropType, expectedCropVariety) {
            console.log('üîç Validating crop match:', {
                expected: { cropType: expectedCropType, variety: expectedCropVariety },
                searchData: searchData
            });

            if (!searchData.productions || searchData.productions.length === 0) {
                return {
                    isValid: false,
                    error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
                    actualCropType: null,
                    actualCropVariety: null
                };
            }

            // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ production record ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö SearchCode
            // ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏à‡∏≤‡∏Å ProductionID ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö SearchCode ‡∏´‡∏£‡∏∑‡∏≠ LotCode
            console.log('üå± Available productions:', searchData.productions.map(p => ({
                ProductionID: p.ProductionID,
                CropType: p.CropType,
                CropVariety: p.CropVariety,
                Created: p.Created
            })));

            // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏´‡∏≤‡∏à‡∏≤‡∏Å harvest data ‡∏ó‡∏µ‡πà‡∏°‡∏µ LotCode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö SearchCode date
            const searchDateCode = searchData.searchCode.split('-')[0]; // 25680909
            console.log('üóìÔ∏è SearchCode date part:', searchDateCode);

            let targetProduction = null;

            // ‡∏´‡∏≤‡∏à‡∏≤‡∏Å harvest records ‡∏ó‡∏µ‡πà‡∏°‡∏µ LotCode ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
            if (searchData.harvests && searchData.harvests.length > 0) {
                const relatedHarvest = searchData.harvests.find(h => {
                    const lotCodeStr = h.LotCode ? h.LotCode.toString() : '';
                    return lotCodeStr === searchDateCode;
                });

                if (relatedHarvest) {
                    console.log('üéØ Found related harvest:', relatedHarvest);
                    targetProduction = searchData.productions.find(p => p.ProductionID === relatedHarvest.ProductionID);
                    console.log('üéØ Found target production from harvest:', targetProduction);
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏à‡∏≤‡∏Å production ‡∏ó‡∏µ‡πà‡∏°‡∏µ CropType ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (!targetProduction) {
                console.log('üîç Searching by expected crop type:', expectedCropType);
                targetProduction = searchData.productions.find(p => p.CropType === expectedCropType);
                console.log('üéØ Found production by crop type:', targetProduction);
            }

            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ production ‡πÅ‡∏£‡∏Å
            if (!targetProduction) {
                console.log('‚ö†Ô∏è No specific production found, using first one');
                targetProduction = searchData.productions[0];
            }

            const actualCropType = targetProduction.CropType || '';
            const actualCropVariety = targetProduction.CropVariety || '';

            console.log('üå± Actual crop data from system:', {
                actualCropType,
                actualCropVariety
            });

            // Check crop type match
            if (actualCropType !== expectedCropType) {
                return {
                    isValid: false,
                    error: '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô',
                    actualCropType,
                    actualCropVariety,
                    mismatchType: 'cropType'
                };
            }

            // Check crop variety match (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå)
            if (expectedCropVariety === '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå') {
                // ‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                if (actualCropVariety && actualCropVariety.trim() !== '') {
                    return {
                        isValid: false,
                        error: '‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå',
                        actualCropType,
                        actualCropVariety,
                        mismatchType: 'cropVariety'
                    };
                }
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö = ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            } else {
                // ‡∏ú‡∏±‡∏Å‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (actualCropVariety !== expectedCropVariety) {
                    return {
                        isValid: false,
                        error: '‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô',
                        actualCropType,
                        actualCropVariety,
                        mismatchType: 'cropVariety'
                    };
                }
            }

            return {
                isValid: true,
                actualCropType,
                actualCropVariety
            };
        }

        // Show QR Code mismatch error with detailed information
        function showQRCodeMismatchError(currentQRCode, searchResultQRCode, searchCode) {
            console.log('üö´ Displaying QR Code mismatch error:', {
                currentQRCode, searchResultQRCode, searchCode
            });
            
            let errorMessage = `‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö QR Code ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô\n\n`;
            errorMessage += `üîç ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï: ${searchCode}\n`;
            errorMessage += `üì± QR Code ‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô: ${currentQRCode}\n`;
            errorMessage += `üìã ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á: ${searchResultQRCode}\n\n`;
            errorMessage += `üí° ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n`;
            errorMessage += `   ‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï\n`;
            errorMessage += `   ‚Ä¢ ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (${searchResultQRCode})\n`;
            errorMessage += `   ‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á ${currentQRCode}`;

            // Show enhanced error alert with warning style
            showAlert('error', errorMessage);

            // Hide any existing results
            hideAllResults();
            
            // Focus back to search code input for retry
            const searchCodeInput = document.getElementById('cropVerificationSearchCode');
            if (searchCodeInput) {
                searchCodeInput.focus();
                searchCodeInput.select();
            }
            
            console.log('‚ùå QR Code mismatch error displayed');
        }

        // Show crop validation error from Google Apps Script with enhanced details
        function showCropValidationErrorFromGAS(result, expectedCropType, expectedCropVariety) {
            console.log('üö´ Displaying crop validation error from Google Apps Script:', result);
            
            // Determine the type of error
            let errorTitle = '‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
            let errorDetails = '';
            
            if (!result.actualCropType && !result.actualCropVariety) {
                errorTitle = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                errorDetails = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheets';
            } else {
                // Compare expected vs actual
                const cropTypeMatch = result.actualCropType === expectedCropType;
                const cropVarietyMatch = result.actualCropVariety === expectedCropVariety;
                
                if (!cropTypeMatch && !cropVarietyMatch) {
                    errorDetails = '‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                } else if (!cropTypeMatch) {
                    errorDetails = '‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                } else if (!cropVarietyMatch) {
                    errorDetails = '‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                }
            }
            
            let errorMessage = `${errorTitle}\n\n${errorDetails}\n\n`;
            errorMessage += `üéØ ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:\n`;
            errorMessage += `   ‚Ä¢ ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${expectedCropType}\n`;
            errorMessage += `   ‚Ä¢ ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${expectedCropVariety}\n\n`;
            errorMessage += `üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Google Sheets:\n`;
            errorMessage += `   ‚Ä¢ ‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å: ${result.actualCropType || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}\n`;
            errorMessage += `   ‚Ä¢ ‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: ${result.actualCropVariety || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}\n`;
            
            if (result.matchedProductionID) {
                errorMessage += `   ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï: ${result.matchedProductionID}\n`;
            }
            
            errorMessage += `\nüí° ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n`;
            errorMessage += `   ‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï\n`;
            errorMessage += `   ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á\n`;
            errorMessage += `   ‚Ä¢ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`;

            // Show enhanced error alert with warning style
            showAlert('warning', errorMessage);

            // Hide any existing results
            hideAllResults();
            
            // Focus back to crop selection for retry
            const cropTypeSelect = document.getElementById('expectedCropType');
            if (cropTypeSelect) {
                cropTypeSelect.focus();
            }
            
            console.log('‚ùå Crop validation failed from Google Apps Script:', result);
        }

        // Legacy: Show crop validation error with detailed information
        function showCropValidationError(validationResult, expectedCropType, expectedCropVariety) {
            // Redirect to new function for consistency
            showCropValidationErrorFromGAS(validationResult, expectedCropType, expectedCropVariety);
        }

        // Show production results with data
        function showProductionResults(data = null) {
            hideAllResults();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (data) {
                displayResults(data);
            }
            
            const productionResults = document.getElementById('productionResults');
            if (productionResults) {
                productionResults.style.display = 'block';
                // Scroll to results
                productionResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Initialize crop verification when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeSearch();
            enhanceUserInterface();
            initializeCropVerification(); // Add crop verification initialization
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>