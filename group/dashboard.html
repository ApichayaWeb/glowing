<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุมผู้จัดการกลุ่ม - ระบบสอบย้อนกลับผักอุดร</title>
    
    <!-- Resource hints for better performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root{
            /* Purple Theme Colors */
            --bg:#f5f3ff;            /* page bg - light purple */
            --card:#ffffff;          /* card bg */
            --muted:#6b46c1;         /* muted text - purple */
            --text:#2e1065;          /* main text - dark purple */
            --brand:#7c4dff;         /* primary purple */
            --brand-2:#651fff;       /* primary darker purple */
            --accent:#ff8a3d;        /* accent */
            --ring: rgba(124,77,255,.35);
            --shadow: 0 10px 30px rgba(101, 31, 255, .12);
            --radius:18px;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        html{scroll-behavior:smooth}
        body{
            margin:0;
            font-family:"Noto Sans Thai", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background:
                radial-gradient(900px 500px at 85% -10%, rgba(155,135,245,.22), transparent),
                radial-gradient(800px 500px at -10% 10%, rgba(124,77,255,.18), transparent),
                var(--bg);
            color:var(--text);
            line-height:1.6;
        }
        a{color:inherit;text-decoration:none}
        .container{width:min(1120px, 92vw); margin-inline:auto}

        /* NAVBAR */
        .nav, .navbar{
            position:sticky; top:0; z-index:50;
            backdrop-filter:saturate(160%) blur(8px);
            background:rgba(255,255,255,.85);
            border-bottom:1px solid rgba(46,16,101,.08);
        }
        .nav-inner, .navbar .container-fluid{display:flex;align-items:center;gap:16px; padding:14px 0}
        .brand, .navbar-brand{display:flex;align-items:center;gap:12px; font-weight:800; letter-spacing:.2px; color:#2e1065}
        .brand .logo, .navbar-brand .brand-icon{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;
            background:conic-gradient(from 210deg at 50% 50%, #7c4dff 0 40%, #651fff 40% 70%, #ffd166 70% 100%);
            box-shadow:inset 0 0 0 4px rgba(0,0,0,.03), 0 6px 18px rgba(124,77,255,.25);
        }
        .spacer{flex:1}
        .nav a.link, .navbar .nav-link{opacity:.85; transition:.2s; padding:.5rem .75rem; border-radius:10px}
        .nav a.link:hover, .navbar .nav-link:hover{opacity:1; background:rgba(124,77,255,.08)}
        .navbar .nav-link.active{background:rgba(124,77,255,.15); color:var(--brand)}

        /* BUTTONS */
        .btn, .btn-primary{display:inline-flex; align-items:center; gap:8px; padding:.65rem 1rem; border-radius:12px;
            background:linear-gradient(180deg, var(--brand), var(--brand-2)); box-shadow:0 10px 18px rgba(124,77,255,.25);
            color:#fff; font-weight:800; border:none}
        .btn:hover, .btn-primary:hover{filter:brightness(1.03)}
        .btn-outline, .btn-outline-primary{display:inline-flex; align-items:center; gap:8px; padding:.55rem .95rem; border-radius:12px;
            border:2px solid var(--brand); color:var(--brand); font-weight:800; background:transparent}
        .btn-outline:hover, .btn-outline-primary:hover{background:rgba(124,77,255,.08)}
        .btn-success{background:linear-gradient(180deg, var(--brand), var(--brand-2)) !important; border:none}
        .btn-info{background:linear-gradient(180deg, #8b5cf6, #7c3aed) !important; border:none}
        .btn-warning{background:linear-gradient(180deg, #a855f7, #9333ea) !important; border:none}

        /* CARDS */
        .card{background:var(--card); border:1px solid rgba(46,16,101,.08); border-radius:var(--radius); box-shadow:var(--shadow)}
        .card-header{background:linear-gradient(135deg, rgba(124,77,255,.12), rgba(255,255,255,.7)); border-bottom:1px solid rgba(46,16,101,.08)}
        
        /* STATS CARDS */
        .stat-card{transition:transform 0.3s ease}
        .stat-card:hover{transform:translateY(-2px)}
        .text-primary{color:var(--brand) !important}
        .text-success{color:#9333ea !important}
        .text-info{color:#8b5cf6 !important}
        .text-warning{color:#a855f7 !important}
        .bg-primary{background:var(--brand) !important}
        .bg-success{background:#9333ea !important}
        .bg-info{background:#8b5cf6 !important}
        .bg-warning{background:#a855f7 !important}
        
        /* PROGRESS BARS */
        .progress-bar{background:linear-gradient(90deg, var(--brand), var(--brand-2))}
        .progress-bar.bg-success{background:linear-gradient(90deg, #9333ea, #7e22ce) !important}
        .progress-bar.bg-info{background:linear-gradient(90deg, #8b5cf6, #7c3aed) !important}
        .progress-bar.bg-warning{background:linear-gradient(90deg, #a855f7, #9333ea) !important}
        
        /* FORM CONTROLS */
        .form-control:focus, .form-select:focus{
            border-color:var(--brand);
            box-shadow:0 0 0 0.2rem rgba(124,77,255,.25);
        }
        
        /* BADGES */
        .badge.bg-primary{background:var(--brand) !important}
        .badge.bg-success{background:#9333ea !important}
        .badge.bg-info{background:#8b5cf6 !important}
        .badge.bg-warning{background:#a855f7 !important}
        
        /* RESPONSIVE */
        @media (max-width: 980px){
            .container-fluid{padding-left:1rem; padding-right:1rem}
        }
    </style>
</head>
<body>
    <!-- Enhanced Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top custom-navbar">
        <div class="container-fluid px-4">
            <!-- Brand -->
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <div class="brand-icon me-3">
                    <img src="../assets/images/logo.png" width="32" height="32" alt="โลโก้" style="display:block;" />
                </div>
                <div class="brand-text">
                    <div class="brand-title">ระบบสอบย้อนกลับผักอุดร</div>
                    <div class="brand-subtitle">Group Dashboard</div>
                </div>
            </a>

            <!-- Mobile Toggle -->
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navigation Items -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Main Navigation -->
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item mx-1">
                        <a class="nav-link nav-link-custom active" href="dashboard.html">
                            <i class="fas fa-tachometer-alt nav-icon"></i>
                            <span class="nav-text">แผงควบคุม</span>
                        </a>
                    </li>
                </ul>

                <!-- User Menu -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="user-info d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="user-details d-none d-lg-block">
                                    <div class="user-name user-display" id="navbarDisplayName">Group Manager</div>
                                    <div class="user-role">ผู้จัดการกลุ่ม</div>
                                </div>
                                <span class="d-lg-none ms-2">Manager (ผู้จัดการกลุ่ม)</span>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end user-dropdown">
                            <li class="dropdown-header">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-circle me-2 text-success"></i>
                                    <div>
                                        <div class="fw-bold user-display">Group Manager</div>
                                        <small class="text-muted">ผู้จัดการกลุ่ม</small>
                                    </div>
                                </div>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item dropdown-item-custom" href="#" onclick="changePassword()">
                                    <i class="fas fa-key me-3 text-primary"></i>
                                    <span>เปลี่ยนรหัสผ่าน</span>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item dropdown-item-custom logout-btn" href="#" onclick="console.log('Logout clicked'); AuthAPI.confirmLogout(); return false;">
                                    <i class="fas fa-sign-out-alt me-3 text-danger"></i>
                                    <span>ออกจากระบบ</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="page-header">
                        <h1 class="h3 mb-3 fw-bold text-success">
                            <i class="fas fa-users me-3"></i>
                            แผงควบคุมผู้จัดการกลุ่ม
                        </h1>
                        <p class="text-muted">จัดการกลุ่มเกษตรกรและสมาชิกในกลุ่ม</p>
                    </div>
                </div>
            </div>

            <!-- Group Information and Farmers List -->
            <div class="row mb-4" id="groupInfo">
                <!-- Group info will be loaded here -->
            </div>


            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>
                                เมนูด่วน
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100" onclick="showAddFarmerForm()">
                                        <i class="fas fa-user-plus me-2"></i>
                                        เพิ่มเกษตรกร
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-warning w-100" onclick="changePassword()">
                                        <i class="fas fa-key me-2"></i>
                                        เปลี่ยนรหัสผ่าน
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Group Profile Modal -->
    <div class="modal fade" id="editGroupProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users-cog me-2"></i>แก้ไขข้อมูลกลุ่ม
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editGroupProfileForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="editGroupName" class="form-label">ชื่อกลุ่มเกษตรกร <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editGroupName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRegistrationDoc" class="form-label">หนังสือจดทะเบียนวิสาหกิจชุมชน</label>
                                <div id="editRegistrationDocContainer">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editGapCert" class="form-label">ใบรับรองแหล่งผลิต GAP</label>
                                <div id="editGapCertContainer">
                                    <!-- Dynamic content will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>บันทึก
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>เปลี่ยนรหัสผ่าน
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="changePasswordForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="oldPassword" class="form-label">รหัสผ่านเดิม</label>
                            <input type="password" class="form-control" id="oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>เปลี่ยนรหัสผ่าน
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Farmer Details Modal -->
    <div class="modal fade" id="farmerDetailsModal" tabindex="-1" aria-labelledby="farmerDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="farmerDetailsModalLabel">
                        <i class="fas fa-user-circle me-2"></i>รายละเอียดเกษตรกร: <span id="detailFarmerName">-</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">รหัสเกษตรกร</label>
                                <p class="form-control-plaintext" id="detailFarmerId">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ชื่อ-นามสกุล</label>
                                <p class="form-control-plaintext" id="detailFarmerFullName">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">หมายเลขแปลง</label>
                                <p class="form-control-plaintext" id="detailPlotNumber">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">เลขบัตรประชาชน</label>
                                <p class="form-control-plaintext" id="detailIdCard">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">เบอร์โทรศัพท์</label>
                                <p class="form-control-plaintext" id="detailPhone">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ที่อยู่</label>
                                <p class="form-control-plaintext" id="detailAddress">-</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">พื้นที่การเพาะปลูก (ไร่)</label>
                                <p class="form-control-plaintext" id="detailArea">-</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ชื่อผู้ใช้</label>
                                <p class="form-control-plaintext" id="detailUsername">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-success mb-3" role="status">
                        <span class="visually-hidden">กำลังโหลด...</span>
                    </div>
                    <h5>กำลังโหลดข้อมูล...</h5>
                    <p class="text-muted">กรุณารอสักครู่</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical scripts - Load immediately -->
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    
    <!-- Non-critical scripts - Load asynchronously after page load -->
    <script>
        // Load external libraries asynchronously after page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                // Load Bootstrap
                const bootstrap = document.createElement('script');
                bootstrap.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
                bootstrap.async = true;
                document.head.appendChild(bootstrap);
                
                // Load SweetAlert2
                const sweetAlert = document.createElement('script');
                sweetAlert.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
                sweetAlert.async = true;
                document.head.appendChild(sweetAlert);
                
                // Load Axios
                const axios = document.createElement('script');
                axios.src = 'https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js';
                axios.async = true;
                document.head.appendChild(axios);
            }, 100);
        });
    </script>

    <style>
        .main-content {
            padding-top: 100px;
            padding-bottom: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Enhanced Navbar Styles */
        .custom-navbar {
            background: linear-gradient(135deg, #2c5530 0%, #28a745 50%, #20c997 100%);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            padding: 0.5rem 0;
        }

        .brand-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #28a745;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .brand-text {
            line-height: 1.2;
        }

        .brand-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            font-weight: 400;
        }

        .nav-link-custom {
            padding: 0.75rem 1rem !important;
            margin: 0 0.25rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.9) !important;
            position: relative;
            overflow: hidden;
        }

        .nav-link-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 10px;
        }

        .nav-link-custom:hover::before,
        .nav-link-custom.active::before {
            opacity: 1;
        }

        .nav-link-custom:hover,
        .nav-link-custom.active {
            color: white !important;
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-icon {
            width: 18px;
            text-align: center;
            margin-right: 0.5rem;
        }

        .nav-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-menu {
            padding: 0.5rem 1rem !important;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: rgba(255,255,255,0.9) !important;
        }

        .user-menu:hover {
            background: rgba(255,255,255,0.1);
            color: white !important;
        }

        .user-avatar i {
            font-size: 2rem;
            color: #fff;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            line-height: 1.2;
        }

        .user-role {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            line-height: 1.2;
        }

        .user-dropdown {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            min-width: 280px;
        }

        .dropdown-header {
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px 10px 0 0;
            margin-bottom: 0.5rem;
        }

        .dropdown-item-custom {
            padding: 0.75rem 1.25rem;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0.25rem 0.5rem;
        }

        .dropdown-item-custom:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateX(5px);
        }

        .navbar-toggler {
            padding: 0.5rem;
            border-radius: 8px;
        }

        .navbar-toggler:focus {
            box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
        }

        .page-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 1rem;
        }

        .group-info {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-radius: 12px;
            padding: 1rem;
            border-left: 4px solid #198754;
        }

        .stats-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 0.875rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .farmer-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .farmer-item:last-child {
            border-bottom: none;
        }

        .farmer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #198754;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-size: 0.75rem;
        }

        .farmer-status {
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .main-content {
                padding-top: 80px;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .activity-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            .activity-icon {
                margin-bottom: 0.5rem;
            }
        }
    </style>

    <script>
        // Global variables with caching
        let currentUser = null;
        let groupData = null;
        let groupStats = null;
        
        // ⚡ IMPROVED CACHE: Enhanced cache with separate TTL for different data types
        const dataCache = {
            groupData: null,
            farmersData: null,
            lastGroupUpdate: null,
            lastFarmersUpdate: null,
            groupTTL: 10 * 60 * 1000, // 10 minutes for group data (changes less frequently)
            farmersTTL: 2 * 60 * 1000  // 2 minutes for farmers data (changes more frequently)
        };
        
        // Check if specific cache is valid
        function isCacheValid(type = 'group') {
            if (type === 'group') {
                return dataCache.lastGroupUpdate && 
                       (Date.now() - dataCache.lastGroupUpdate) < dataCache.groupTTL;
            } else if (type === 'farmers') {
                return dataCache.lastFarmersUpdate && 
                       (Date.now() - dataCache.lastFarmersUpdate) < dataCache.farmersTTL;
            }
            return false;
        }
        
        // Invalidate cache when data changes
        function invalidateCache(type = 'all') {
            console.log('Cache invalidated:', type);
            if (type === 'all' || type === 'group') {
                dataCache.groupData = null;
                dataCache.lastGroupUpdate = null;
            }
            if (type === 'all' || type === 'farmers') {
                dataCache.farmersData = null;
                dataCache.lastFarmersUpdate = null;
            }
        }
        
        // Setup lazy loading for images and heavy content
        function setupLazyLoading() {
            // Lazy load images using Intersection Observer
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            imageObserver.unobserve(img);
                        }
                    });
                });
                
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Fallback for browsers without Intersection Observer
                document.querySelectorAll('img[data-src]').forEach(img => {
                    img.src = img.dataset.src;
                });
            }
        }

        // Block auth.js navigation BEFORE DOM loaded
        if (typeof AuthAPI !== 'undefined') {
            AuthAPI.setupNavigation = function() {
                console.log('setupNavigation blocked in group dashboard');
                return;
            };
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== GROUP DASHBOARD INITIALIZATION ===');
            console.log('DOM loaded, starting initialization...');
            
            // Check if required APIs are loaded
            console.log('AuthAPI available:', typeof AuthAPI !== 'undefined');
            console.log('PageProtection available:', typeof PageProtection !== 'undefined');
            console.log('Utils available:', typeof Utils !== 'undefined');
            
            // Block auth.js navigation again to be sure
            if (typeof AuthAPI !== 'undefined') {
                AuthAPI.setupNavigation = function() {
                    console.log('setupNavigation blocked in group dashboard DOM ready');
                    return;
                };
            }
            
            // Show loading message immediately
            const groupInfoElement = document.getElementById('groupInfo');
            if (groupInfoElement) {
                groupInfoElement.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        กำลังโหลดข้อมูล... 
                        <small class="d-block mt-1">หากไม่มีการเปลี่ยนแปลงใน 5 วินาที โปรดตรวจสอบ Console</small>
                    </div>
                `;
                console.log('Loading message displayed');
            } else {
                console.error('groupInfo element not found!');
                return;
            }
            
            // Add event listeners for checkbox controls
            setupCheckboxListeners();
            
            // Check login status
            const currentUser = AuthAPI?.getCurrentUser();
            console.log('=== CURRENT USER DEBUG ===');
            console.log('Current user object:', currentUser);
            if (currentUser) {
                console.log('Username:', currentUser.username);
                console.log('Role:', currentUser.role);
                console.log('GroupID fields:', {
                    groupId: currentUser.groupId,
                    GroupID: currentUser.GroupID,
                    group_id: currentUser.group_id
                });
                console.log('GroupCode fields:', {
                    groupCode: currentUser.groupCode,
                    GroupCode: currentUser.GroupCode,
                    group_code: currentUser.group_code
                });
                console.log('All user fields:', Object.keys(currentUser));
                console.log('User data from localStorage (raw):', localStorage.getItem('user_data'));
                console.log('UserData parsed:', JSON.parse(localStorage.getItem('user_data') || '{}'));
                
                // Check for potential data mismatch
                const rawData = localStorage.getItem('user_data');
                if (rawData) {
                    const parsed = JSON.parse(rawData);
                    console.log('=== DATA MISMATCH CHECK ===');
                    console.log('AuthAPI.getCurrentUser() returned:', currentUser.username, currentUser.groupId);
                    console.log('localStorage directly contains:', parsed.username, parsed.groupId || parsed.GroupID || parsed.group_id);
                    
                    // Also check all localStorage keys related to user
                    console.log('=== ALL LOCALSTORAGE KEYS ===');
                    Object.keys(localStorage).forEach(key => {
                        if (key.includes('user') || key.includes('User') || key.includes('auth') || key.includes('group') || key.includes('Group')) {
                            console.log(`${key}:`, localStorage.getItem(key));
                        }
                    });
                }
            }
            
            if (!currentUser) {
                groupInfoElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ไม่พบข้อมูลผู้ใช้ กรุณา <a href="../login.html">เข้าสู่ระบบ</a>
                    </div>
                `;
                console.error('No current user found');
                return;
            }
            
            // Protect group page - only group managers can access
            console.log('Checking page protection...');
            if (!PageProtection.protectGroupPage()) {
                console.error('Access denied - not group manager or not logged in');
                groupInfoElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-ban me-2"></i>
                        ไม่มีสิทธิ์เข้าถึง - ต้องเป็นผู้จัดการกลุ่มเท่านั้น
                    </div>
                `;
                return;
            }
            
            console.log('Group manager access granted');
            
            // Clean up any auth navigation items
            cleanupAuthNavItems();
            
            // Setup page WITHOUT auth.js navigation (use static navigation instead)
            console.log('Setting up page...');
            if (AuthAPI.setupPage({ setupNavigation: false })) {
                console.log('Page setup completed successfully');
                
                // Update user display in static navigation
                updateUserNavigation();
                
                console.log('Loading dashboard data in parallel...');
                // Load data in parallel for better performance
                Promise.all([
                    loadGroupData(),
                    loadFarmersList()
                ]).then(() => {
                    console.log('All dashboard data loaded successfully');
                }).catch(error => {
                    console.error('Error loading dashboard data:', error);
                });
                setupEventListeners();
                
                // Setup lazy loading for images
                setupLazyLoading();
            } else {
                console.error('Page setup failed');
                groupInfoElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        การตั้งค่าหน้าเว็บล้มเหลว
                    </div>
                `;
            }
            
            // Set up periodic cleanup and protection
            // ⚡ PERFORMANCE: ลดความถี่จาก 500ms เป็น 5000ms (5 วินาที)
            setInterval(cleanupAuthNavItems, 5000);
            setupNavbarProtection();
            
            console.log('=== INITIALIZATION COMPLETE ===');
        });
        
        // Update user display in navigation
        function updateUserNavigation() {
            const currentUser = AuthAPI.getCurrentUser();
            console.log('Updating user navigation with:', currentUser);
            
            if (currentUser) {
                // Update user display name
                const userDisplayElement = document.querySelector('.user-display');
                if (userDisplayElement) {
                    userDisplayElement.textContent = currentUser.fullName || currentUser.username || 'ผู้จัดการกลุ่ม';
                    console.log('Updated user display to:', userDisplayElement.textContent);
                }
                
                // Add user role display if element exists
                let userRoleElement = document.querySelector('.user-role');
                if (!userRoleElement) {
                    // Create user role element if it doesn't exist
                    const dropdownToggle = document.querySelector('.nav-link.dropdown-toggle');
                    if (dropdownToggle) {
                        userRoleElement = document.createElement('small');
                        userRoleElement.className = 'user-role text-light d-block';
                        userRoleElement.style.fontSize = '0.75rem';
                        dropdownToggle.appendChild(userRoleElement);
                    }
                }
                
                if (userRoleElement) {
                    userRoleElement.textContent = 'ผู้จัดการกลุ่ม';
                    console.log('Updated user role to: ผู้จัดการกลุ่ม');
                }
            } else {
                console.warn('No current user found for navigation update');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Edit group profile form - remove existing listeners first to prevent duplicates
            const editForm = document.getElementById('editGroupProfileForm');
            if (editForm) {
                editForm.removeEventListener('submit', handleEditGroupProfile);
                editForm.addEventListener('submit', handleEditGroupProfile);
            }
            
            // Change password form
            const passwordForm = document.getElementById('changePasswordForm');
            if (passwordForm) {
                passwordForm.removeEventListener('submit', handleChangePassword);
                passwordForm.addEventListener('submit', handleChangePassword);
            }
            
            // Logout button
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('Logout button event listener added');
            } else {
                console.warn('Logout button not found');
            }
        }
        
        // Handle logout
        function handleLogout(event) {
            event.preventDefault();
            console.log('Logout button clicked');
            
            // Show confirmation dialog
            Swal.fire({
                title: 'ออกจากระบบ',
                text: 'คุณต้องการออกจากระบบใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ออกจากระบบ',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Perform logout
                    AuthAPI.logout();
                    
                    // Show success message and redirect
                    Swal.fire({
                        title: 'ออกจากระบบสำเร็จ',
                        text: 'กำลังนำคุณไปยังหน้าเข้าสู่ระบบ...',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        // Redirect to login page
                        window.location.href = '../login.html';
                    });
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            console.log('=== LOADING DASHBOARD DATA ===');
            
            // Check group permission before loading data
            const currentUser = AuthAPI.getCurrentUser();
            console.log('Current user for dashboard:', currentUser);
            
            if (!currentUser || !currentUser.role || currentUser.role.toString().trim().toLowerCase() !== 'group') {
                console.error('Permission denied: Group manager role required');
                Utils.showError('ไม่มีสิทธิ์', 'คุณต้องมีสิทธิ์ผู้จัดการกลุ่มเท่านั้น');
                setTimeout(() => window.location.href = '../login.html', 2000);
                return;
            }
            
            try {
                // ปิด showLoading ชั่วคราวเพื่อ debug
                // Utils.showLoading('กำลังโหลดข้อมูล...');
                console.log('Skipping showLoading for debugging...');
                
                // หาข้อมูลกลุ่มจาก username ของผู้ใช้
                console.log('Finding group data for user:', currentUser.username);
                
                // ใช้ข้อมูลพื้นฐานแทนการเรียก API ที่ไม่มีอยู่
                console.log('🆕 Creating group profile for user:', currentUser.username);
                
                // ลอง API เพื่อโหลดข้อมูลกลุ่มจริง
                let groupData = null;
                let groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                if (!groupId) {
                    console.error('No GroupID found in user data');
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูล GroupID ในบัญชีของคุณ กรุณาออกจากระบบและเข้าใหม่');
                    return;
                }
                
                try {
                    console.log('=== GROUP DATA LOADING DEBUG ===');
                    console.log('Loading group data for groupId:', groupId);
                    console.log('Current user for context:', {
                        username: currentUser.username,
                        role: currentUser.role,
                        groupId: currentUser.groupId,
                        GroupID: currentUser.GroupID,
                        group_id: currentUser.group_id
                    });
                    
                    const groupResult = await GroupAPI.getGroupData(groupId);
                    console.log('Group data API result:', groupResult);
                    
                    if (groupResult.success && groupResult.data) {
                        groupData = groupResult.data;
                        console.log('Loaded group data from API:', groupData);
                        console.log('Group data details:', {
                            groupCode: groupData.groupCode,
                            groupName: groupData.groupName,
                            managerName: groupData.managerName,
                            registrationDoc: groupData.registrationDoc,
                            gapCert: groupData.gapCert
                        });
                    }
                } catch (apiError) {
                    console.warn('Failed to load group data from API:', apiError);
                }
                
                // ถ้าไม่ได้ข้อมูลจาก API ให้ใช้ข้อมูลพื้นฐาน
                if (!groupData) {
                    console.log('Using basic group data template');
                    groupData = {
                        groupCode: groupId,
                        groupName: '',
                        managerName: currentUser.username,
                        registrationDoc: '',
                        gapCert: '',
                        status: 'active',
                        totalFarmers: 0,
                        isNewUser: true // Flag สำหรับผู้ใช้ใหม่
                    };
                }
                
                groupStats = {
                    totalFarmers: 0,
                    activeFarmers: 0,
                    totalPlots: 0,
                    completedProfiles: 0,
                    monthlyActivity: 0
                };
                
                console.log('Displaying group setup form and farmers list');
                displayGroupInfo(groupData);
                
                // ลบข้อความยินดีต้อนรับ - ไม่ต้องการแล้ว
                
                console.log('=== DASHBOARD DATA LOADED ===');
                
            } catch (error) {
                console.error('Error in loadDashboardData:', error);
                // Utils.hideLoading(); // ปิดชั่วคราวเพื่อ debug
                
                // หากเกิด error ให้แสดงข้อมูลพื้นฐานแทน
                console.log('API error, showing basic form');
                
                groupData = {
                    groupCode: currentUser.groupCode || currentUser.GroupCode || null,
                    groupName: '',
                    managerName: currentUser.username,
                    registrationDoc: '',
                    gapCert: '',
                    status: 'active',
                    totalFarmers: 0
                };
                
                groupStats = {
                    totalFarmers: 0,
                    activeFarmers: 0,
                    totalPlots: 0,
                    completedProfiles: 0,
                    monthlyActivity: 0
                };
                
                displayGroupInfo(groupData);
            }
        }
        
        // Setup checkbox event listeners for re-upload controls
        function setupCheckboxListeners() {
            // Use event delegation to handle dynamically created elements
            document.addEventListener('change', function(e) {
                if (e.target.id === 'reuploadRegistrationCheck') {
                    const fileInput = document.getElementById('registrationDocInput');
                    if (fileInput) {
                        fileInput.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
                
                if (e.target.id === 'reuploadGapCheck') {
                    const fileInput = document.getElementById('gapCertInput');
                    if (fileInput) {
                        fileInput.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
        }
        
        // Update navbar display name based on group data
        function updateNavbarDisplayName(group) {
            const navbarDisplayName = document.getElementById('navbarDisplayName');
            const currentUser = AuthAPI.getCurrentUser();
            
            if (navbarDisplayName && currentUser) {
                // ถ้ามีชื่อกลุ่ม ให้แสดงชื่อกลุ่ม ถ้าไม่มี ให้แสดง username
                const displayName = ((group.GroupName || group.groupName) && (group.GroupName || group.groupName).trim() !== '') 
                    ? (group.GroupName || group.groupName)
                    : currentUser.username;
                    
                navbarDisplayName.textContent = displayName;
            }
        }
        
        // Setup document containers for modal with checkbox logic
        function setupModalDocumentContainers(groupData) {
            // ตรวจสอบการมีอยู่ของเอกสาร (รองรับทั้ง Capitalized และ lowercase fields)
            const registrationDocField = groupData.RegistrationDoc || groupData.registrationDoc;
            const gapCertField = groupData.GAPCert || groupData.gapCert;
            
            const hasRegistrationDoc = groupData && registrationDocField && 
                                      typeof registrationDocField === 'string' && 
                                      registrationDocField.trim() !== '';
            const hasGAPCert = groupData && gapCertField && 
                              typeof gapCertField === 'string' && 
                              gapCertField.trim() !== '';
            
            console.log('=== SETUP MODAL DEBUG ===');
            console.log('groupData:', groupData);
            console.log('RegistrationDoc field:', registrationDocField, 'hasRegistrationDoc:', hasRegistrationDoc);
            console.log('GAPCert field:', gapCertField, 'hasGAPCert:', hasGAPCert);
            
            // Registration document container
            const regContainer = document.getElementById('editRegistrationDocContainer');
            if (!regContainer) {
                console.error('editRegistrationDocContainer not found!');
                return;
            }
            regContainer.innerHTML = hasRegistrationDoc ? `
                <div class="mb-2">
                    <small class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</small>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="editReuploadRegistrationCheck">
                    <label class="form-check-label" for="editReuploadRegistrationCheck">
                        ต้องการอัปโหลดใหม่
                    </label>
                </div>
                <input type="file" class="form-control" id="editRegistrationDoc" accept="image/*" style="display: none;">
            ` : `
                <input type="file" class="form-control" id="editRegistrationDoc" accept="image/*">
                <small class="text-muted">สามารถอัปโหลดทีหลังได้</small>
            `;
            
            // GAP certificate container
            const gapContainer = document.getElementById('editGapCertContainer');
            if (!gapContainer) {
                console.error('editGapCertContainer not found!');
                return;
            }
            gapContainer.innerHTML = hasGAPCert ? `
                <div class="mb-2">
                    <small class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</small>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="editReuploadGapCheck">
                    <label class="form-check-label" for="editReuploadGapCheck">
                        ต้องการอัปโหลดใหม่
                    </label>
                </div>
                <input type="file" class="form-control" id="editGapCert" accept="image/*" style="display: none;">
            ` : `
                <input type="file" class="form-control" id="editGapCert" accept="image/*">
                <small class="text-muted">สามารถอัปโหลดทีหลังได้</small>
            `;
            
            // Add event listeners for checkboxes
            setTimeout(() => {
                const regCheck = document.getElementById('editReuploadRegistrationCheck');
                const gapCheck = document.getElementById('editReuploadGapCheck');
                
                if (regCheck) {
                    regCheck.addEventListener('change', function() {
                        const fileInput = document.getElementById('editRegistrationDoc');
                        if (fileInput) {
                            fileInput.style.display = this.checked ? 'block' : 'none';
                        }
                    });
                }
                
                if (gapCheck) {
                    gapCheck.addEventListener('change', function() {
                        const fileInput = document.getElementById('editGapCert');
                        if (fileInput) {
                            fileInput.style.display = this.checked ? 'block' : 'none';
                        }
                    });
                }
            }, 100);
        }

        // Display group info
        function displayGroupInfo(group) {
            console.log('=== DISPLAY GROUP INFO ===');
            console.log('Group object received:', group);
            console.log('Group object keys:', Object.keys(group || {}));
            
            const groupInfoElement = document.getElementById('groupInfo');
            
            // Update navbar display name
            updateNavbarDisplayName(group);
            
            // Check if group data is complete - เฉพาะชื่อกลุ่มเป็นข้อมูลบังคับ
            // API ส่งมาเป็น Capitalized fields: GroupName, RegistrationDoc, GAPCert
            const hasGroupName = (group.GroupName || group.groupName) && (group.GroupName || group.groupName).trim() !== '';
            
            // ตรวจสอบ Registration Document จากหลายรูปแบบ field name
            // 🚨 TEMPORARY FIX: Backend มี bug ในการ map ข้อมูล - ตอนนี้ข้อมูลไปอยู่ใน district และ province
            const regDoc = group.RegistrationDoc || group.registrationDoc || group.RegistrationDocument || group.RegDoc || 
                          group.district || ''; // TEMPORARY: Backend maps RegistrationDoc to district
            const hasRegistrationDoc = regDoc && regDoc.trim() !== '';
            
            // ตรวจสอบ GAP Certificate จากหลายรูปแบบ field name  
            const gapCert = group.GAPCert || group.gapCert || group.GAPCertificate || group.Gap || 
                           group.province || ''; // TEMPORARY: Backend maps GAPCert to province  
            const hasGAPCert = gapCert && gapCert.trim() !== '';
            const isComplete = hasGroupName; // เฉพาะชื่อกลุ่มเป็นข้อมูลบังคับ
            
            console.log('Data completion check:');
            console.log('- hasGroupName:', hasGroupName, '(GroupName:', group.GroupName, ', groupName:', group.groupName, ')');
            console.log('- hasRegistrationDoc:', hasRegistrationDoc, '(Found value:', regDoc, ')');
            console.log('- hasGAPCert:', hasGAPCert, '(Found value:', gapCert, ')');
            console.log('- isComplete:', isComplete);
            
            // ADDITIONAL DEBUG: Check all possible field variations
            console.log('=== FIELD VARIATIONS DEBUG ===');
            const regDocVariations = {
                'RegistrationDoc': group.RegistrationDoc,
                'registrationDoc': group.registrationDoc,
                'RegistrationDocument': group.RegistrationDocument,
                'RegDoc': group.RegDoc,
                'district (TEMP FIX)': group.district // Backend bug mapping
            };
            const gapCertVariations = {
                'GAPCert': group.GAPCert,
                'gapCert': group.gapCert,
                'GAPCertificate': group.GAPCertificate,
                'Gap': group.Gap,
                'province (TEMP FIX)': group.province // Backend bug mapping
            };
            console.log('Registration Document variations:', regDocVariations);
            console.log('GAP Certificate variations:', gapCertVariations);
            console.log('============================');
            
            // แสดงใน format cards แนวตั้ง เต็มความกว้าง
            groupInfoElement.innerHTML = `
                <!-- Group Information Card - Full Width -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-building me-2"></i>
                                    ข้อมูลกลุ่มเกษตรกร
                                </h5>
                            </div>
                            <div class="card-body">
                                ${!isComplete ? `
                                    <!-- Form for incomplete data -->
                                    <div class="alert ${group.isNewUser ? 'alert-info' : 'alert-warning'} mb-3">
                                        <i class="fas ${group.isNewUser ? 'fa-info-circle' : 'fa-exclamation-triangle'} me-2"></i>
                                        <small>
                                            ${group.isNewUser ? 
                                                '🎉 ยินดีต้อนรับสู่ระบบ! กรุณากรอกข้อมูลกลุ่มของคุณให้ครบถ้วน' : 
                                                'กรุณากรอกข้อมูลให้ครบถ้วน'
                                            }
                                        </small>
                                    </div>
                                    <form id="groupDataForm">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <label class="form-label">ชื่อกลุ่มเกษตรกร <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="groupNameInput" 
                                                       value="${group.GroupName || group.groupName || ''}" placeholder="กรอกชื่อกลุ่มเกษตรกร">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">หนังสือจดทะเบียนวิสาหกิจชุมชน</label>
                                                ${hasRegistrationDoc ? `
                                                    <div class="mb-2">
                                                        <small class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</small>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="reuploadRegistrationCheck">
                                                        <label class="form-check-label" for="reuploadRegistrationCheck">
                                                            ต้องการอัปโหลดใหม่
                                                        </label>
                                                    </div>
                                                    <input type="file" class="form-control" id="registrationDocInput" accept="image/*" style="display: none;">
                                                ` : `
                                                    <input type="file" class="form-control" id="registrationDocInput" accept="image/*">
                                                    <small class="text-muted">สามารถอัปโหลดทีหลังได้</small>
                                                `}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">ใบรับรองแหล่งผลิต GAP</label>
                                                ${hasGAPCert ? `
                                                    <div class="mb-2">
                                                        <small class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</small>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="reuploadGapCheck">
                                                        <label class="form-check-label" for="reuploadGapCheck">
                                                            ต้องการอัปโหลดใหม่
                                                        </label>
                                                    </div>
                                                    <input type="file" class="form-control" id="gapCertInput" accept="image/*" style="display: none;">
                                                ` : `
                                                    <input type="file" class="form-control" id="gapCertInput" accept="image/*">
                                                    <small class="text-muted">สามารถอัปโหลดทีหลังได้</small>
                                                `}
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-2"></i>บันทึกข้อมูล
                                            </button>
                                        </div>
                                    </form>
                                ` : `
                                    <!-- Display complete data -->
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h6 class="text-success mb-2">ข้อมูลพื้นฐาน</h6>
                                            <p class="mb-1">
                                                <strong>ชื่อกลุ่ม:</strong> ${group.GroupName || group.groupName}
                                            </p>
                                            <p class="mb-0">
                                                <strong>สมาชิก:</strong> <span data-member-count>${group.totalFarmers || 0} คน</span>
                                            </p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-success mb-2">เอกสารประกอบ</h6>
                                            <p class="mb-1">
                                                <i class="fas fa-file-alt text-info me-2"></i>
                                                <strong>หนังสือจดทะเบียน:</strong> 
                                                ${hasRegistrationDoc ? `
                                                    <span class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</span>
                                                    <button class="btn btn-outline-primary btn-sm ms-2" onclick="viewDocument('registration', '${regDoc}')" title="คลิกดูไฟล์">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                ` : `<span class="text-muted">ยังไม่ได้อัปโหลด</span>`}
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-certificate text-success me-2"></i>
                                                <strong>ใบรับรอง GAP:</strong> 
                                                ${hasGAPCert ? `
                                                    <span class="text-success"><i class="fas fa-check"></i> อัปโหลดแล้ว</span>
                                                    <button class="btn btn-outline-success btn-sm ms-2" onclick="viewDocument('gap', '${gapCert}')" title="คลิกดูไฟล์">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                ` : `<span class="text-muted">ยังไม่ได้อัปโหลด</span>`}
                                            </p>
                                            <p class="mb-0">
                                                <strong>สถานะ:</strong> 
                                                <span class="badge bg-success">เปิดใช้งาน</span>
                                            </p>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-outline-primary btn-sm" onclick="editGroupProfile()">
                                                <i class="fas fa-edit me-1"></i>แก้ไขข้อมูล
                                            </button>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Farmers List Card - Full Width -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2 text-info"></i>
                                    รายชื่อเกษตรกรในกลุ่ม
                                </h5>
                                <button class="btn btn-success btn-sm" onclick="showAddFarmerForm()">
                                    <i class="fas fa-user-plus me-1"></i>เพิ่มเกษตรกร
                                </button>
                            </div>
                            <div class="card-body" id="farmersList">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i> กำลังโหลดรายชื่อเกษตรกร...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup form handler if not complete
            if (!isComplete) {
                document.getElementById('groupDataForm').addEventListener('submit', handleGroupDataSubmit);
            }
            
            // Always load farmers list (cache will be used if valid)
            loadFarmersList();
        }
        


        // Handle group data form submission
        async function handleGroupDataSubmit(event) {
            event.preventDefault();
            
            const groupName = document.getElementById('groupNameInput').value.trim();
            const registrationDoc = document.getElementById('registrationDocInput').files[0];
            const gapCert = document.getElementById('gapCertInput').files[0];
            
            if (!groupName) {
                Utils.showWarning('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อกลุ่มเกษตรกร');
                return;
            }
            
            // แจ้งเตือนถ้าไม่มีเอกสารใหม่และยังไม่เคยอัปโหลด (แต่ไม่บล็อก)
            const reuploadRegCheck = document.getElementById('reuploadRegistrationCheck');
            const reuploadGapCheck = document.getElementById('reuploadGapCheck');
            
            // ตรวจสอบว่าจะมีการอัปโหลดเอกสารใหม่หรือไม่
            const willUploadRegistration = registrationDoc || (reuploadRegCheck && !reuploadRegCheck.checked);
            const willUploadGap = gapCert || (reuploadGapCheck && !reuploadGapCheck.checked);
            
            if (!registrationDoc && !gapCert && (!willUploadRegistration || !willUploadGap)) {
                const confirmResult = await Utils.showConfirm(
                    'ยืนยันการบันทึก',
                    'คุณยังไม่ได้อัปโหลดเอกสารใหม่ หากต้องการอัปโหลดทีหลังสามารถทำได้ คุณต้องการบันทึกข้อมูลต่อไปหรือไม่?',
                    'บันทึกต่อไป',
                    'ยกเลิก'
                );
                
                if (!confirmResult.isConfirmed) {
                    return;
                }
            }
            
            try {
                Utils.showLoading('กำลังบันทึกข้อมูล...');
                
                const currentUser = AuthAPI.getCurrentUser();
                
                console.log('=== DEBUG Group Data Submit ===');
                console.log('Current user:', currentUser);
                console.log('Available groupId fields:', {
                    groupId: currentUser.groupId,
                    GroupID: currentUser.GroupID, 
                    group_id: currentUser.group_id
                });
                
                // ตรวจสอบ groupId - ใช้ข้อมูลจาก login จริงเท่านั้น
                let groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                if (!groupId) {
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูล GroupID ในบัญชีของคุณ กรุณาติดต่อผู้ดูแลระบบ');
                    Utils.hideLoading();
                    return;
                }
                
                console.log('Using groupId:', groupId);
                console.log('Files to upload:', {
                    registrationDoc: registrationDoc ? registrationDoc.name : 'none',
                    gapCert: gapCert ? gapCert.name : 'none'
                });
                
                // ใช้ GroupCode จาก currentUser หรือ groupData 
                let groupCode = currentUser.groupCode || currentUser.GroupCode || groupData?.groupCode;
                
                // เรียก API เฉพาะเมื่อไม่มี groupCode
                if (!groupCode) {
                    console.log('Need to fetch GroupCode from API...');
                    const groupDataResult = await API.makeRequest('getGroupData', { groupId: groupId });
                    if (groupDataResult.success) {
                        groupCode = groupDataResult.data.groupCode;
                    } else {
                        Utils.showError('ข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลกลุ่มได้');
                        Utils.hideLoading();
                        return;
                    }
                }
                
                console.log('Using groupCode:', groupCode);
                
                const updateData = { 
                    groupId: groupId,
                    groupCode: groupCode,
                    groupName: groupName,
                    managerUsername: currentUser.username
                };
                
                // Upload files in parallel for better performance
                const uploadPromises = [];
                
                if (registrationDoc) {
                    console.log('Starting registration doc upload...');
                    uploadPromises.push(
                        API.uploadFileToGroupFolder(registrationDoc, groupId, 'registration', null)
                            .then(result => {
                                console.log('Registration upload result:', result);
                                updateData.registrationDoc = registrationDoc.name;
                            })
                    );
                }
                
                if (gapCert) {
                    console.log('Starting GAP cert upload...');
                    uploadPromises.push(
                        API.uploadFileToGroupFolder(gapCert, groupId, 'gap_certificate', null)
                            .then(result => {
                                console.log('GAP upload result:', result);
                                updateData.gapCert = gapCert.name;
                            })
                    );
                }
                
                // Wait for all uploads to complete in parallel
                if (uploadPromises.length > 0) {
                    console.log('Waiting for', uploadPromises.length, 'file uploads...');
                    await Promise.all(uploadPromises);
                    console.log('All file uploads completed');
                }
                
                console.log('=== DEBUG: UPDATE GROUP PROFILE ===');
                console.log('Sending updateData to API:', updateData);
                console.log('updateData fields:');
                Object.keys(updateData).forEach(key => {
                    console.log(`  ${key}:`, typeof updateData[key], updateData[key]);
                });
                
                // Update group profile
                const result = await GroupAPI.updateGroupProfile(updateData);
                
                console.log('=== API RESPONSE ===');
                console.log('Full API response:', result);
                console.log('Success:', result?.success);
                console.log('Message:', result?.message);
                console.log('Data:', result?.data);
                
                if (result.success) {
                    Utils.hideLoading(); // Hide loading first
                    Utils.showSuccess('บันทึกสำเร็จ', result.message || 'ข้อมูลกลุ่มได้รับการอัพเดทแล้ว');
                    
                    // Update navbar display name immediately
                    const updatedGroup = { groupName: groupName };
                    updateNavbarDisplayName(updatedGroup);
                    
                    // ตรวจสอบและปรับปรุง GroupID ใน current user ให้ตรงกับฐานข้อมูล
                    const currentGroupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                    if (!currentGroupId || currentGroupId !== groupId) {
                        console.log('Updating user GroupID to match database:', groupId);
                        currentUser.groupId = groupId;
                        currentUser.GroupID = groupId; // สำรองใน field ที่อาจใช้
                        
                        // บันทึกลง localStorage (เฉพาะ user data)
                        AuthAPI.updateCurrentUser(currentUser);
                        console.log('Updated current user with correct GroupID:', currentUser);
                    }
                    
                    // Update groupData in memory - ไม่ต้อง reload
                    // Fix: Check if groupData is null before setting properties
                    if (!groupData) {
                        groupData = {
                            groupCode: groupCode,
                            managerName: currentUser.username,
                            status: 'active',
                            totalFarmers: 0
                        };
                    }
                    groupData.groupName = groupName;
                    groupData.groupCode = groupCode; // เพิ่ม groupCode
                    if (updateData.registrationDoc) groupData.registrationDoc = updateData.registrationDoc;
                    if (updateData.gapCert) groupData.gapCert = updateData.gapCert;
                    
                    console.log('Updated groupData in memory:', groupData);
                    
                    // Refresh display immediately - ไม่ต้องรอ
                    displayGroupInfo(groupData);
                } else {
                    Utils.hideLoading();
                    console.error('API Error Details:', {
                        success: result.success,
                        message: result.message,
                        fullResult: result
                    });
                    
                    Utils.showError('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกข้อมูลได้');
                }
                
            } catch (error) {
                Utils.hideLoading();
                handleAPIError(error, 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
            }
        }
        
        // Load group data only (with caching)
        async function loadGroupData() {
            let currentUser;
            try {
                currentUser = AuthAPI.getCurrentUser();
                if (!currentUser) {
                    throw new Error('ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
                }
                
                const groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                
                console.log('=== GROUP DATA LOADING DEBUG ===');
                console.log('Current user object:', currentUser);
                console.log('Extracted groupId:', groupId);
                console.log('groupId type:', typeof groupId);
                console.log('================================');
                
                // ⚡ IMPROVED CACHE: Check cache first with specific type
                if (isCacheValid('group') && dataCache.groupData) {
                    console.log('⚡ Using cached group data');
                    groupData = dataCache.groupData;
                    displayGroupInfo(groupData);
                    return;
                }
                
                if (!groupId) {
                    throw new Error('ไม่พบ Group ID ในข้อมูลผู้ใช้ กรุณาติดต่อผู้ดูแลระบบ');
                }
                
                console.log('🌐 Calling GroupAPI.getGroupData with groupId:', groupId);
                const groupResult = await GroupAPI.getGroupData(groupId);
                console.log('=== GROUP API RESPONSE ===');
                console.log('Full API response:', groupResult);
                console.log('Group data fields:', groupResult.data ? Object.keys(groupResult.data) : 'No data');
                console.log('Group data content:', groupResult.data);
                
                console.log('=== API SUCCESS CHECK ===');
                console.log('groupResult.success:', groupResult.success);
                console.log('groupResult.data exists:', !!groupResult.data);
                console.log('groupResult.message:', groupResult.message);
                console.log('========================');
                
                if (groupResult.success && groupResult.data) {
                    console.log('✅ API call successful, using real data');
                    groupData = groupResult.data;
                    console.log('Processed groupData:', groupData);
                    // ⚡ IMPROVED CACHE: Update group cache with separate timestamp
                    dataCache.groupData = groupData;
                    dataCache.lastGroupUpdate = Date.now();
                    displayGroupInfo(groupData);
                } else {
                    console.log('❌ API call failed or no data, using fallback data');
                    console.log('Fallback reason - success:', groupResult.success, 'has data:', !!groupResult.data);
                    
                    // Create more complete fallback data with field variations
                    groupData = {
                        groupCode: currentUser.groupCode || currentUser.GroupCode || '02',
                        GroupCode: currentUser.groupCode || currentUser.GroupCode || '02', // Add capitalized version
                        groupName: 'กลุ่มเกษตรกร',
                        GroupName: 'กลุ่มเกษตรกร', // Add capitalized version
                        managerName: currentUser.username || 'ผู้จัดการกลุ่ม',
                        registrationDoc: '',
                        RegistrationDoc: '', // Add capitalized version
                        gapCert: '',
                        GAPCert: '', // Add capitalized version
                        status: 'active',
                        totalFarmers: 0,
                        statistics: {
                            totalFarmers: 0,
                            totalQRCodes: 0,
                            totalSearchCodes: 0
                        }
                    };
                    console.log('Using enhanced fallback groupData:', groupData);
                    displayGroupInfo(groupData);
                    
                    // แสดงแจ้งเตือนเฉพาะเมื่อไม่สามารถเชื่อมต่อ API ได้
                    if (!groupResult || groupResult.message) {
                        setTimeout(() => {
                            Utils.showInfo(
                                'ข้อมูลจากแคช', 
                                'กำลังใช้ข้อมูลพื้นฐานเนื่องจากไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้'
                            );
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error loading group data:', error);
                
                // ใช้ข้อมูลพื้นฐานจาก currentUser เป็น fallback (ป้องกันกรณี currentUser เป็น null)
                const fallbackGroupCode = currentUser?.groupCode || currentUser?.GroupCode || 'ไม่ระบุ';
                const fallbackManagerName = currentUser?.username || currentUser?.fullName || 'ผู้จัดการ';
                
                // ถ้าไม่มี currentUser เลย ให้ redirect ไปหน้า login
                if (!currentUser) {
                    console.error('CurrentUser is null, redirecting to login');
                    Utils.showError('เซสชันหมดอายุ', 'กรุณาเข้าสู่ระบบใหม่');
                    setTimeout(() => {
                        window.location.href = '../login.html';
                    }, 2000);
                    return;
                }
                
                groupData = {
                    groupCode: fallbackGroupCode,
                    GroupCode: fallbackGroupCode, // Add capitalized version
                    groupName: 'กลุ่มเกษตรกร',
                    GroupName: 'กลุ่มเกษตรกร', // Add capitalized version
                    managerName: fallbackManagerName,
                    registrationDoc: '',
                    RegistrationDoc: '', // Add capitalized version
                    gapCert: '',
                    GAPCert: '', // Add capitalized version
                    status: 'active',
                    totalFarmers: 0,
                    statistics: {
                        totalFarmers: 0,
                        totalQRCodes: 0,
                        totalSearchCodes: 0
                    }
                };
                
                console.warn('Using fallback group data:', groupData);
                displayGroupInfo(groupData);
                
                // แสดงแจ้งเตือนเฉพาะเมื่อไม่มีข้อมูลสำคัญ
                if (!groupData.groupName || !groupData.groupCode) {
                    setTimeout(() => {
                        Utils.showWarning(
                            'โหลดข้อมูลไม่สมบูรณ์', 
                            'ไม่สามารถโหลดข้อมูลกลุ่มจากเซิร์ฟเวอร์ได้ กำลังใช้ข้อมูลพื้นฐาน'
                        );
                    }, 1000);
                }
            }
        }
        
        // Load farmers list (with caching)
        async function loadFarmersList() {
            try {
                const currentUser = AuthAPI.getCurrentUser();
                
                // ⚡ IMPROVED CACHE: Check farmers cache first with specific type
                if (isCacheValid('farmers') && dataCache.farmersData) {
                    console.log('⚡ Using cached farmers data');
                    displayFarmersList(dataCache.farmersData);
                    updateMemberCount(dataCache.farmersData.length);
                    return;
                }
                
                const result = await GroupAPI.getGroupFarmers(currentUser.groupId);
                
                if (result.success) {
                    // ⚡ IMPROVED CACHE: Update farmers cache with separate timestamp
                    dataCache.farmersData = result.farmers;
                    dataCache.lastFarmersUpdate = Date.now();
                    displayFarmersList(result.farmers);
                    updateMemberCount(result.farmers.length);
                } else {
                    document.getElementById('farmersList').innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-users"></i>
                            <p>ไม่มีเกษตรกรในกลุ่ม</p>
                        </div>
                    `;
                    updateMemberCount(0);
                }
            } catch (error) {
                document.getElementById('farmersList').innerHTML = `
                    <div class="text-center text-danger py-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>เกิดข้อผิดพลาดในการโหลดรายชื่อเกษตรกร</p>
                    </div>
                `;
                updateMemberCount(0);
            }
        }
        
        // Display farmers list
        function displayFarmersList(farmers) {
            const farmersContainer = document.getElementById('farmersList');
            
            if (!farmers || farmers.length === 0) {
                farmersContainer.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-users mb-2"></i>
                        <p>ยังไม่มีเกษตรกรในกลุ่ม</p>
                        <button class="btn btn-outline-success btn-sm" onclick="showAddFarmerForm()">
                            <i class="fas fa-user-plus me-1"></i>เพิ่มเกษตรกรคนแรก
                        </button>
                    </div>
                `;
                updateMemberCount(0);
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += `
                <thead class="table-light">
                    <tr>
                        <th>ชื่อ-นามสกุล</th>
                        <th>เบอร์โทรศัพท์</th>
                        <th>แปลงที่</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            farmers.forEach(farmer => {
                // Check if farmer data is incomplete (empty fullName or plotNumber)
                const isIncompleteData = !farmer.fullName || farmer.fullName.trim() === '' || 
                                       !farmer.plotNumber || farmer.plotNumber.trim() === '';
                
                // Determine button type based on data completeness
                const actionButton = isIncompleteData ? 
                    `<button class="btn btn-outline-danger btn-sm" onclick="deleteFarmer('${farmer.farmerId}', '${farmer.fullName || 'เกษตรกรไม่ระบุชื่อ'}')" title="ลบข้อมูล">
                        <i class="fas fa-trash"></i>
                    </button>` :
                    ``; // Hide edit button for now
                
                html += `
                    <tr${isIncompleteData ? ' class="table-warning"' : ''}>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="farmer-avatar ${isIncompleteData ? 'bg-warning text-dark' : 'bg-success text-white'} rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                    ${farmer.fullName ? farmer.fullName.charAt(0) : '?'}
                                </div>
                                <span${isIncompleteData ? ' class="text-muted fst-italic"' : ''}>
                                    ${farmer.fullName || 'ไม่ระบุชื่อ-นามสกุล'}
                                </span>
                                ${isIncompleteData ? '<small class="text-warning ms-1">(ข้อมูลไม่ครบ)</small>' : ''}
                            </div>
                        </td>
                        <td>${farmer.phone || '-'}</td>
                        <td>
                            <span class="badge ${isIncompleteData ? 'bg-warning text-dark' : 'bg-info'}">${farmer.plotNumber || 'ไม่ระบุแปลง'}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewFarmerDetails('${farmer.farmerId}')" title="ดูรายละเอียด">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${actionButton}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            farmersContainer.innerHTML = html;
        }
        
        // Update member count in group info
        function updateMemberCount(count) {
            const memberCountElement = document.querySelector('[data-member-count]');
            if (memberCountElement) {
                memberCountElement.textContent = `${count} คน`;
            }
        }
        
        // Show add farmer form
        function showAddFarmerForm() {
            Swal.fire({
                title: 'เพิ่มเกษตรกรใหม่',
                html: `
                    <form id="addFarmerForm">
                        <div class="mb-3">
                            <label class="form-label">เบอร์โทรศัพท์ <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="farmerPhone" 
                                   placeholder="08XXXXXXXX" pattern="[0-9]{10}" 
                                   maxlength="10" required>
                            <div class="form-text">เบอร์โทรจะใช้เป็น Username สำหรับเข้าสู่ระบบ</div>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                ระบบจะสร้าง Username และ Password อัตโนมัติจากเบอร์โทรศัพท์
                            </small>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'เพิ่มเกษตรกร',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#198754',
                preConfirm: () => {
                    const phone = document.getElementById('farmerPhone').value.trim();
                    
                    if (!phone) {
                        Swal.showValidationMessage('กรุณาใส่เบอร์โทรศัพท์');
                        return false;
                    }
                    
                    return { phone };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    addFarmer(result.value.phone);
                }
            });
        }
        
        // Add farmer
        async function addFarmer(phone) {
            try {
                Utils.showLoading('กำลังเพิ่มเกษตรกร...');
                
                const currentUser = AuthAPI.getCurrentUser();
                
                console.log('=== DEBUG: Add Farmer ===');
                console.log('Full current user data:', JSON.stringify(currentUser, null, 2));
                console.log('User keys:', currentUser ? Object.keys(currentUser) : 'No user');
                
                if (!currentUser) {
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูลผู้ใช้ กรุณาเข้าสู่ระบบใหม่');
                    Utils.hideLoading();
                    return;
                }
                
                // ตรวจสอบทุก field ที่เป็นไปได้สำหรับ group identifier
                const possibleGroupFields = [
                    'groupId', 'GroupID', 'groupCode', 'GroupCode', 
                    'group_id', 'group_code', 'id', 'userGroupId'
                ];
                
                let groupIdentifier = null;
                let foundField = null;
                
                for (const field of possibleGroupFields) {
                    if (currentUser[field]) {
                        groupIdentifier = currentUser[field];
                        foundField = field;
                        break;
                    }
                }
                
                console.log('Group identifier found:', groupIdentifier, 'from field:', foundField);
                
                // ใช้ GroupCode จาก currentUser หรือ groupData หรือดึงจาก API
                let groupCode = currentUser.groupCode || currentUser.GroupCode || groupData?.GroupCode || groupData?.groupCode;
                
                // หากไม่มี GroupCode ให้ดึงจาก API โดยใช้ GroupID
                if (!groupCode) {
                    console.log('GroupCode not found, fetching from API using GroupID:', groupIdentifier);
                    try {
                        const groupResult = await GroupAPI.getGroupData(groupIdentifier);
                        console.log('API response for GroupCode:', groupResult);
                        
                        // API ส่งมาเป็น GroupCode (Capitalized) ไม่ใช่ groupCode
                        if (groupResult.success && groupResult.data && (groupResult.data.GroupCode || groupResult.data.groupCode)) {
                            groupCode = groupResult.data.GroupCode || groupResult.data.groupCode;
                            console.log('Fetched GroupCode from API:', groupCode);
                        } else {
                            console.error('Failed to get GroupCode from API:', groupResult);
                            Utils.showError('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูล GroupCode ได้ กรุณาลองใหม่อีกครั้ง');
                            Utils.hideLoading();
                            return;
                        }
                    } catch (error) {
                        console.error('Error fetching GroupCode:', error);
                        Utils.showError('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการดึงข้อมูลกลุ่ม กรุณาลองใหม่อีกครั้ง');
                        Utils.hideLoading();
                        return;
                    }
                }
                console.log('Add farmer using GroupCode:', groupCode);
                
                // Create farmer data with all required fields
                const farmerData = {
                    action: 'addFarmer',
                    phone: phone.trim(),
                    username: phone.trim(),
                    password: phone.substring(3), // ตัดเบอร์โทร 3 ตัวแรกออก
                    role: 'farmer',
                    groupCode: groupCode, // ใช้ GroupCode แทน groupId
                    status: 'active',
                    created: new Date().toISOString().slice(0, 19).replace('T', ' ') // รูปแบบ 2025-08-26 10:19:05
                };
                
                console.log('Adding farmer with data:', farmerData);
                
                // Use API.makeRequest directly to ensure proper handling
                const result = await API.makeRequest('addFarmer', farmerData);
                
                console.log('Add farmer result:', result);
                
                if (result && result.success) {
                    Utils.showSuccess('เพิ่มเกษตรกรสำเร็จ', 
                        `เบอร์โทร: ${phone}<br>Username: ${phone}<br>Password: ${phone.substring(3)}<br><small class="text-muted">เกษตรกรสามารถใช้เบอร์โทรเข้าสู่ระบบได้</small>`);
                    
                    // Refresh the page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    const errorMsg = result?.message || 'ไม่สามารถเพิ่มเกษตรกรได้';
                    console.error('Add farmer failed:', errorMsg);
                    Utils.showError('เกิดข้อผิดพลาด', errorMsg);
                }
                
                Utils.hideLoading();
                
            } catch (error) {
                console.error('Add farmer error:', error);
                Utils.hideLoading();
                
                let errorMessage = 'เกิดข้อผิดพลาดในการเพิ่มเกษตรกร';
                if (error.message) {
                    errorMessage += ': ' + error.message;
                }
                
                Utils.showError('เกิดข้อผิดพลาด', errorMessage);
            }
        }
        
        // View farmer details - show modal
        async function viewFarmerDetails(farmerId) {
            try {
                console.log('=== VIEW FARMER DETAILS ===');
                console.log('Farmer ID:', farmerId);
                
                // Find farmer in cached data first (no loading needed)
                let farmer = null;
                if (dataCache.farmersData) {
                    farmer = dataCache.farmersData.find(f => f.farmerId === farmerId);
                }
                
                if (!farmer) {
                    // Only show loading if we need to fetch from API
                    Utils.showLoading('กำลังโหลดข้อมูล...');
                    
                    try {
                        // If not in cache, fetch farmer details from API
                        const result = await GroupAPI.getFarmerDetails(farmerId);
                        if (result.success) {
                            farmer = result.farmer;
                        } else {
                            Utils.hideLoading();
                            Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูลเกษตรกรได้');
                            return;
                        }
                    } finally {
                        Utils.hideLoading(); // Always hide loading
                    }
                }
                
                if (!farmer) {
                    Utils.showError('เกิดข้อผิดพลาด', 'ไม่พบข้อมูลเกษตรกร');
                    return;
                }
                
                // Populate modal with farmer data
                document.getElementById('detailFarmerName').textContent = farmer.fullName || 'ไม่ระบุชื่อ';
                document.getElementById('detailFarmerId').textContent = farmer.farmerId || '-';
                document.getElementById('detailFarmerFullName').textContent = farmer.fullName || 'ไม่ระบุชื่อ';
                document.getElementById('detailPlotNumber').textContent = farmer.plotNumber || '-';
                document.getElementById('detailIdCard').textContent = farmer.idCard || '-';
                document.getElementById('detailPhone').textContent = farmer.phone || '-';
                document.getElementById('detailAddress').textContent = farmer.address || '-';
                document.getElementById('detailArea').textContent = farmer.area || '-';
                document.getElementById('detailUsername').textContent = farmer.username || '-';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('farmerDetailsModal'));
                modal.show();
                
            } catch (error) {
                console.error('View farmer details error:', error);
                Utils.hideLoading(); // Make sure loading is hidden on error
                Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถแสดงรายละเอียดเกษตรกรได้');
            }
        }
        
        // Redirect showFarmerDetails calls to viewFarmerDetails  
        function showFarmerDetails(farmerId) {
            viewFarmerDetails(farmerId);
        }

        // Edit group profile
        async function editGroupProfile() {
            try {
                // Check group permission
                const currentUser = AuthAPI.getCurrentUser();
                if (!currentUser || !currentUser.role || currentUser.role.toString().trim().toLowerCase() !== 'group') {
                    Utils.showError('ไม่มีสิทธิ์', 'คุณต้องมีสิทธิ์ผู้จัดการกลุ่มเท่านั้น');
                    return;
                }
                
                // โหลดข้อมูลกลุ่มจาก Google Sheet
                let groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                if (!groupId) {
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูล GroupID ในบัญชีของคุณ');
                    return;
                }
                
                const groupDataResult = await API.makeRequest('getGroupData', { groupId: groupId });
                if (!groupDataResult.success) {
                    Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลกลุ่มได้');
                    return;
                }
                
                const currentGroupData = groupDataResult.data;
                
                // Fill form data (รองรับทั้ง Capitalized และ lowercase fields)
                document.getElementById('editGroupName').value = currentGroupData.GroupName || currentGroupData.groupName || '';
                
                // Setup document containers with checkbox logic
                setupModalDocumentContainers(currentGroupData);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editGroupProfileModal'));
                modal.show();
                
            } catch (error) {
                console.error('Edit group profile error:', error);
                Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลแก้ไขได้');
            }
        }
        
        // Handle edit group profile
        async function handleEditGroupProfile(event) {
            event.preventDefault();
            
            // Get submit button and manage its state directly
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = submitButton ? submitButton.innerHTML : '';
            
            // Function to reset button state
            function resetButtonState() {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            }
            
            // Check group permission
            const currentUser = AuthAPI.getCurrentUser();
            if (!currentUser || !currentUser.role || currentUser.role.toString().trim().toLowerCase() !== 'group') {
                Utils.showError('ไม่มีสิทธิ์', 'คุณต้องมีสิทธิ์ผู้จัดการกลุ่มเท่านั้น');
                resetButtonState();
                return;
            }
            
            const groupName = document.getElementById('editGroupName').value.trim();
            const registrationDoc = document.getElementById('editRegistrationDoc')?.files[0];
            const gapCert = document.getElementById('editGapCert')?.files[0];
            
            if (!groupName) {
                Utils.showWarning('ข้อมูลไม่ครบ', 'กรุณาใส่ชื่อกลุ่มเกษตรกร');
                resetButtonState();
                return;
            }
            
            // แจ้งเตือนเมื่อไม่มีการอัพโหลดเอกสารใหม่ (ไม่บล็อกการบันทึก)
            if (!registrationDoc && !gapCert) {
                const confirmResult = await Utils.showConfirm(
                    'ยืนยันการบันทึก',
                    'คุณไม่ได้เลือกไฟล์เอกสารใหม่ จะบันทึกเฉพาะข้อมูลชื่อกลุ่ม คุณต้องการดำเนินการต่อหรือไม่?',
                    'บันทึกต่อไป',
                    'ยกเลิก'
                );
                
                if (!confirmResult.isConfirmed) {
                    resetButtonState();
                    return;
                }
            }

            try {
                // Disable button and show loading state
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
                }
                Utils.showLoading('กำลังบันทึกข้อมูล...');
                
                // ตรวจสอบ groupId - ใช้ข้อมูลจาก login จริงเท่านั้น
                let groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                if (!groupId) {
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูล GroupID ในบัญชีของคุณ');
                    Utils.hideLoading();
                    resetButtonState();
                    return;
                }
                
                // ใช้ GroupCode จาก currentUser หรือ groupData หรือดึงจาก API
                let groupCode = currentUser.groupCode || currentUser.GroupCode || groupData?.GroupCode || groupData?.groupCode;
                
                // หากไม่มี GroupCode ให้ดึงจาก API โดยใช้ GroupID
                if (!groupCode) {
                    const groupIdentifier = currentUser.GroupID || currentUser.groupId || currentUser.groupID;
                    console.log('GroupCode not found for edit, fetching from API using GroupID:', groupIdentifier);
                    try {
                        const groupResult = await GroupAPI.getGroupData(groupIdentifier);
                        console.log('API response for edit GroupCode:', groupResult);
                        
                        // API ส่งมาเป็น GroupCode (Capitalized) ไม่ใช่ groupCode
                        if (groupResult.success && groupResult.data && (groupResult.data.GroupCode || groupResult.data.groupCode)) {
                            groupCode = groupResult.data.GroupCode || groupResult.data.groupCode;
                            console.log('Fetched GroupCode from API for edit:', groupCode);
                        } else {
                            console.error('Failed to get GroupCode from API for edit:', groupResult);
                            Utils.showError('ข้อผิดพลาด', 'ไม่สามารถดึงข้อมูล GroupCode ได้ กรุณาลองใหม่อีกครั้ง');
                            Utils.hideLoading();
                            resetButtonState();
                            return;
                        }
                    } catch (error) {
                        console.error('Error fetching GroupCode for edit:', error);
                        Utils.showError('ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการดึงข้อมูลกลุ่ม กรุณาลองใหม่อีกครั้ง');
                        Utils.hideLoading();
                        resetButtonState();
                        return;
                    }
                }
                console.log('Edit modal using GroupCode:', groupCode);
                
                const updateData = { 
                    groupId: groupId,
                    groupCode: groupCode,
                    groupName: groupName,
                    managerUsername: currentUser.username
                };
                
                // Upload files if provided
                if (registrationDoc) {
                    const registrationResult = await API.uploadFileToGroupFolder(
                        registrationDoc, groupId, 'registration', null
                    );
                    console.log('Registration upload result:', registrationResult);
                    updateData.registrationDoc = registrationDoc.name;
                }
                
                if (gapCert) {
                    const gapResult = await API.uploadFileToGroupFolder(
                        gapCert, groupId, 'gap_certificate', null
                    );
                    console.log('GAP upload result:', gapResult);
                    updateData.gapCert = gapCert.name;
                }
                
                // Call API to update group data
                console.log('=== DEBUG: EDIT MODAL UPDATE ===');
                console.log('Edit modal updateData:', updateData);
                const result = await GroupAPI.updateGroupProfile(updateData);
                console.log('Edit modal API response:', result);
                
                if (result.success) {
                    Utils.hideLoading(); // Hide loading first
                    resetButtonState(); // Reset button state
                    
                    // Close modal first
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editGroupProfileModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Show success message and refresh page
                    Utils.showSuccess('บันทึกสำเร็จ', 'อัพเดทข้อมูลกลุ่มเรียบร้อยแล้ว กำลังรีเฟรชหน้า...');
                    
                    // Refresh page after showing success message
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    Utils.hideLoading();
                    resetButtonState(); // Reset button state
                    Utils.showError('เกิดข้อผิดพลาด', result.message || 'ไม่สามารถบันทึกข้อมูลได้');
                    // Reset form on error as well
                    setTimeout(() => {
                        document.getElementById('editGroupProfileForm').reset();
                    }, 1000);
                }
                
            } catch (error) {
                Utils.hideLoading();
                resetButtonState(); // Reset button state
                handleAPIError(error, 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                // Reset form on error as well
                setTimeout(() => {
                    document.getElementById('editGroupProfileForm').reset();
                }, 1000);
            }
        }

        // Delete farmer function (for incomplete data only)
        async function deleteFarmer(farmerId, farmerName) {
            try {
                console.log('=== DELETE FARMER ===');
                console.log('Farmer ID:', farmerId);
                console.log('Farmer Name:', farmerName);
                
                // Show confirmation dialog
                const result = await Utils.showConfirm(
                    'ยืนยันการลบข้อมูล',
                    `คุณต้องการลบข้อมูลเกษตรกร "${farmerName}" ใช่หรือไม่?\n\nข้อมูลที่ลบแล้วจะไม่สามารถกู้คืนได้`,
                    'warning',
                    'ลบข้อมูล',
                    'ยกเลิก'
                );
                
                if (result.isConfirmed) {
                    Utils.showLoading('กำลังลบข้อมูล...');
                    
                    // Call API to delete farmer
                    const deleteResult = await GroupAPI.deleteFarmer(farmerId);
                    console.log('Delete result:', deleteResult);
                    
                    Utils.hideLoading();
                    
                    if (deleteResult.success) {
                        Utils.showSuccess('สำเร็จ', 'ลบข้อมูลเกษตรกรเรียบร้อยแล้ว');
                        
                        // Refresh the page to show updated data
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                        
                    } else {
                        Utils.showError('เกิดข้อผิดพลาด', deleteResult.message || 'ไม่สามารถลบข้อมูลเกษตรกรได้');
                    }
                }
            } catch (error) {
                console.error('Delete farmer error:', error);
                Utils.hideLoading();
                Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลเกษตรกรได้ กรุณาลองใหม่อีกครั้ง');
            }
        }

        // View document function
        async function viewDocument(documentType, documentPath) {
            try {
                if (!documentPath || documentPath === 'undefined') {
                    Utils.showWarning('ไม่พบไฟล์', 'ยังไม่มีการอัปโหลดไฟล์นี้');
                    return;
                }

                console.log('=== DEBUG VIEW DOCUMENT ===');
                console.log('Document type:', documentType);
                console.log('Document path:', documentPath);
                
                Utils.showLoading('กำลังโหลดไฟล์...');
                
                // Get current user info for group folder path  
                const currentUser = AuthAPI.getCurrentUser();
                let groupId = currentUser.groupId || currentUser.GroupID || currentUser.group_id;
                if (!groupId) {
                    Utils.hideLoading();
                    Utils.showError('ข้อผิดพลาด', 'ไม่พบข้อมูล GroupID ในบัญชีของคุณ');
                    return;
                }
                
                // Request file URL from API
                const result = await API.makeRequest('getFileUrl', {
                    groupId: groupId,
                    fileName: documentPath,
                    fileType: documentType
                });
                
                console.log('Get file URL result:', result);
                
                if (result.success && result.fileUrl) {
                    // Open file in new tab
                    window.open(result.fileUrl, '_blank');
                } else {
                    // If API doesn't work, try constructing URL directly
                    const fileName = documentPath;
                    const displayName = documentType === 'registration' ? 'หนังสือจดทะเบียน' : 'ใบรับรอง GAP';
                    
                    Swal.fire({
                        title: `ดู${displayName}`,
                        text: `ไฟล์: ${fileName}`,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'ดาวน์โหลด',
                        cancelButtonText: 'ปิด'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Trigger download if user wants
                            const link = document.createElement('a');
                            link.href = '#'; // Would need proper file URL
                            link.download = fileName;
                            link.click();
                        }
                    });
                }
                
                Utils.hideLoading();
                
            } catch (error) {
                Utils.hideLoading();
                console.error('View document error:', error);
                Utils.showError('เกิดข้อผิดพลาด', 'ไม่สามารถเปิดไฟล์ได้: ' + error.message);
            }
        }

        // Change password
        function changePassword() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        // Handle change password
        async function handleChangePassword(event) {
            event.preventDefault();
            
            // Check group permission
            const currentUser = AuthAPI.getCurrentUser();
            if (!currentUser || !currentUser.role || currentUser.role.toString().trim().toLowerCase() !== 'group') {
                Utils.showError('ไม่มีสิทธิ์', 'คุณต้องมีสิทธิ์ผู้จัดการกลุ่มเท่านั้น');
                return;
            }
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                Utils.showWarning('รหัสผ่านไม่ตรงกัน', 'กรุณาตรวจสอบรหัสผ่านใหม่');
                return;
            }

            try {
                await AuthAPI.changePassword(oldPassword, newPassword);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
                
                Utils.showSuccess('เปลี่ยนรหัสผ่านสำเร็จ', 'รหัสผ่านของคุณได้ถูกเปลี่ยนเรียบร้อยแล้ว');
                
                // Clear form
                document.getElementById('changePasswordForm').reset();
                
            } catch (error) {
                handleAPIError(error, 'เกิดข้อผิดพลาดในการเปลี่ยนรหัสผ่าน');
            }
        }

        // Cleanup function to remove unwanted auth nav items
        function cleanupAuthNavItems() {
            // Remove by class
            const authNavItems = document.querySelectorAll('.auth-nav-item');
            if (authNavItems.length > 0) {
                console.log('Cleaning up', authNavItems.length, 'auth nav items by class');
                authNavItems.forEach(item => item.remove());
            }
            
            // Remove navbar-text spans that might contain user info
            const navbarTexts = document.querySelectorAll('.navbar-text');
            navbarTexts.forEach(text => {
                if (text.textContent.includes('สวัสดี,') || 
                    text.textContent.includes('AA') ||
                    text.textContent.includes('ผู้จัดการกลุ่ม')) {
                    console.log('Removing navbar-text:', text.textContent);
                    text.parentElement?.remove();
                }
            });
            
            // Remove any extra navigation links after the main dashboard link
            const mainNavbar = document.querySelector('.navbar-nav.me-auto');
            if (mainNavbar) {
                const allItems = Array.from(mainNavbar.children);
                allItems.forEach((item, index) => {
                    if (index >= 1) { // Keep only the first item (แผงควบคุม)
                        console.log('Removing extra nav item:', item);
                        item.remove();
                    }
                });
            }
        }

        // Setup navbar protection with MutationObserver
        function setupNavbarProtection() {
            const mainNavbar = document.querySelector('.navbar-nav.me-auto');
            if (!mainNavbar) return;
            
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check if added node is an auth-nav-item
                            if (node.classList?.contains('auth-nav-item') || 
                                node.querySelector?.('.auth-nav-item')) {
                                console.log('MutationObserver: Removing dynamically added auth nav item');
                                node.remove();
                            }
                            
                            // Check for navbar-text with user info
                            if (node.classList?.contains('navbar-text') || 
                                node.querySelector?.('.navbar-text')) {
                                if (node.textContent?.includes('สวัสดี,') || 
                                    node.textContent?.includes('AA') ||
                                    node.textContent?.includes('ผู้จัดการกลุ่ม')) {
                                    console.log('MutationObserver: Removing user info text');
                                    node.remove();
                                }
                            }
                        }
                    });
                });
            });
            
            observer.observe(mainNavbar, {
                childList: true,
                subtree: true
            });
            
            console.log('Navbar protection MutationObserver setup complete');
        }

    </script>
</body>
</html>